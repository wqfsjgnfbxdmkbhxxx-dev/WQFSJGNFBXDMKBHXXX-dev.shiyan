<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™‹æ±Ÿæ–‡å­¦åŸ - AIçµæ„Ÿåˆ›ä½œä¸­å¿ƒ v2.3</title>
    <style>
        :root {
            --jj-green: #009966;
            --jj-light-green: #eef7f2;
            --jj-pink: #ffc0cb;
            --jj-text: #333;
            --jj-gray: #999;
            --jj-border: #ddd;
            --bg-color: #f4f4f4;
            --reader-bg: #f6f4ec;
        }

        body {
            font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--jj-text);
            padding-bottom: 60px;
        }

        /* é€šç”¨ç»„ä»¶ */
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; transition: opacity 0.2s; }
        .btn:active { opacity: 0.8; }
        .btn-jj { background-color: var(--jj-green); color: white; }
        .btn-outline { border: 1px solid var(--jj-green); color: var(--jj-green); background: white; }
        .btn-danger { border: 1px solid #ff4d4f; color: #ff4d4f; background: white; }
        .card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--jj-green); }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid var(--jj-border); border-radius: 4px; box-sizing: border-box; }
        
        /* å¯¼èˆªæ  */
        .navbar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; border-top: 1px solid var(--jj-border);
            display: flex; justify-content: space-around; padding: 10px 0;
            z-index: 1000;
        }
        .nav-item { text-align: center; color: var(--jj-gray); cursor: pointer; font-size: 12px; }
        .nav-item.active { color: var(--jj-green); font-weight: bold; }
        .nav-icon { display: block; font-size: 20px; margin-bottom: 2px; }

        /* é¡µé¢æ˜¾ç¤ºæ§åˆ¶ */
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- é¦–é¡µï¼šåˆ›ä½œä¸­å¿ƒ --- */
        .header-logo { color: var(--jj-green); font-size: 24px; font-weight: bold; text-align: center; margin: 20px 0; font-family: "SimSun", serif; }
        .tag-cloud { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .tag-chip { background: var(--jj-light-green); color: var(--jj-green); padding: 4px 10px; border-radius: 20px; font-size: 12px; cursor: pointer; }
        .tag-chip.custom { border: 1px solid var(--jj-green); }

        .book-preview-item { display: flex; border-bottom: 1px dashed var(--jj-border); padding: 10px 0; cursor: pointer; }
        .book-info { flex: 1; } 
        .book-info h3 { margin: 0 0 5px 0; font-size: 16px; color: #1a1a1a; font-weight: bold;}
        .book-meta { font-size: 12px; color: var(--jj-gray); margin-bottom: 5px; }
        .book-intro { font-size: 13px; color: #666; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* --- åˆ†é¡µæ§ä»¶ --- */
        .pagination-container { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px; padding-bottom: 20px; }
        .page-num { font-size: 14px; color: #666; }

        /* --- ä¹¦ç±è¯¦æƒ…é¡µ (ä»¿æ™‹æ±ŸUI) --- */
        .jj-detail-header { display: flex; gap: 15px; margin-bottom: 20px; }
        .jj-cover-lg { width: 120px; height: 160px; background: #f0f0f0; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 5px; font-family: "SimSun", serif; border: 1px solid #ddd;}
        .jj-meta-info h1 { margin: 0 0 10px 0; font-size: 20px; color: var(--jj-green); }
        .jj-stat-row { font-size: 13px; color: #333; margin-bottom: 5px; }
        .jj-stat-highlight { color: #ff3300; font-weight: bold; }
        .jj-copy-box { border: 2px solid var(--jj-light-green); padding: 15px; font-size: 15px; line-height: 1.8; color: #333; margin-bottom: 15px; white-space: pre-wrap; }
        .jj-tags { font-size: 13px; color: var(--jj-green); margin-top: 10px; }
        .jj-tag-item { color: #000; font-weight: normal; }
        .jj-chapter-list { border: 1px solid var(--jj-border); max-height: 400px; overflow-y: auto; }
        .jj-chapter-row { padding: 10px; border-bottom: 1px solid var(--jj-border); display: flex; justify-content: space-between; font-size: 14px; cursor: pointer;}
        .jj-chapter-row:hover { background-color: #f9f9f9; }
        .jj-chapter-row:last-child { border-bottom: none; }
        .jj-vip { color: red; font-size: 12px; border: 1px solid red; padding: 0 2px; margin-left: 5px; }

        /* --- é˜…è¯»å™¨é¡µé¢ --- */
        .reader-content { 
            background-color: var(--reader-bg); 
            padding: 20px; 
            min-height: 80vh; 
            line-height: 1.8; 
            font-size: 18px; 
            color: #2b2b2b; 
            white-space: pre-wrap;
            border-radius: 4px;
        }
        .reader-title {
            font-size: 28px; /* åŠ å¤§å­—ä½“ */
            font-weight: bold;
            margin-bottom: 30px;
            text-align: center;
            color: #1a1a1a;
            font-family: "SimSun", serif;
            line-height: 1.4;
        }

        /* --- ä¹¦æ¶ (ä¿®æ”¹éƒ¨åˆ†) --- */
        /* æ”¹ä¸ºFlexåˆ—è¡¨å¸ƒå±€ï¼Œè€ŒéGrid */
        .bookshelf-grid { 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
        }
        
        .shelf-book { 
            display: flex; 
            background: white; 
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer; 
            position: relative;
            text-align: left; /* é‡ç½®å¯¹é½æ–¹å¼ */
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }

        .shelf-book:active {
            background-color: #fafafa;
        }

        .shelf-book .book-cover-sm { 
            width: 70px; 
            height: 93px; 
            background: #eee; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 10px; 
            color: #aaa; 
            text-align: center; 
            flex-shrink: 0;
            margin-right: 15px;
            border-radius: 4px;
        }

        .shelf-book-info-col {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .shelf-book-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 6px;
        }

        .shelf-book-intro {
            font-size: 12px;
            color: #888;
            line-height: 1.5;
            /* é™åˆ¶æ˜¾ç¤º3è¡Œ */
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* --- ä¸–ç•Œè§‚ --- */
        .setting-item { background: #fff; padding: 10px; border-left: 4px solid var(--jj-green); margin-bottom: 10px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .btn-group { display: flex; gap: 5px; }
        .btn-sm { padding: 4px 8px; font-size: 12px; }
        .setting-list { margin-top: 15px; }
        .edit-mode-box { border: 1px dashed var(--jj-green); padding: 10px; background: #f9f9f9; margin-bottom: 10px; border-radius: 4px; }
        .setting-item-actions { display: flex; gap: 5px; margin-top: 5px; justify-content: flex-end; }
        .setting-content { white-space: pre-wrap; font-size: 13px; color: #555; margin-top: 5px; }

        /* --- æ–°å¢æ ·å¼ --- */
        .author-say-box { margin-top: 10px; border: none; background: transparent; padding: 0; }
        .author-say-header { 
            background: var(--jj-light-green); 
            color: var(--jj-green); 
            padding: 10px 15px; 
            border-radius: 4px; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-weight: bold;
            border: 1px solid var(--jj-green);
            transition: all 0.2s;
        }
        .author-say-header:hover { background: #e0f0e9; }
        .author-say-content { 
            margin-top: 5px; 
            font-size: 14px; 
            color: #555; 
            white-space: pre-wrap; 
            display: none; 
            background: #fff;
            padding: 15px;
            border: 1px dashed var(--jj-green);
            border-radius: 4px;
        }
        .author-say-content.show { display: block; }
        
        .comment-section { margin-top: 10px; border-top: 1px solid #eee; padding-top: 15px; }
        .comment-item { margin-bottom: 15px; border-bottom: 1px dashed #eee; padding-bottom: 10px; }
        .comment-user { font-size: 12px; color: var(--jj-gray); margin-bottom: 4px; display: flex; justify-content: space-between; }
        .comment-text { font-size: 14px; color: #333; }
        
        .abandoned-chapter-row { padding: 8px 10px 8px 30px; font-size: 12px; color: #999; background: #fcfcfc; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
        .abandoned-tag { background: #ddd; color: #666; padding: 1px 4px; border-radius: 3px; font-size: 10px; margin-right: 5px; }

        /* ç›®å½•å¼¹çª— */
        .catalog-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: flex-end; }
        .catalog-modal.show { display: flex; }
        .catalog-content { width: 80%; max-width: 300px; background: white; height: 100%; display: flex; flex-direction: column; animation: slideInRight 0.3s; }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .catalog-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .catalog-list { flex: 1; overflow-y: auto; padding: 10px; }
        .catalog-item { padding: 12px 10px; border-bottom: 1px solid #f5f5f5; cursor: pointer; font-size: 14px; }
        .catalog-item:hover { background: #f9f9f9; }
        .catalog-item.active { color: var(--jj-green); font-weight: bold; background-color: #eef7f2; }
        .catalog-item.abandoned { color: #999; font-size: 13px; padding-left: 25px; border-left: 3px solid #ddd; }

        /* --- ä¸–ç•Œè§‚é¡µé¢ Tab æ ·å¼ --- */
        .world-tabs { display: flex; border-bottom: 1px solid var(--jj-border); margin-bottom: 15px; background: #fff; border-radius: 8px 8px 0 0; overflow: hidden; }
        .world-tab-item { flex: 1; text-align: center; padding: 12px; cursor: pointer; background: #f9f9f9; color: #666; border-right: 1px solid #eee; }
        .world-tab-item:last-child { border-right: none; }
        .world-tab-item.active { background: #fff; color: var(--jj-green); font-weight: bold; border-bottom: 2px solid var(--jj-green); }

        /* æ ‡ç­¾å¹³é“ºæ ·å¼ */
        .tag-list-container { display: flex; flex-wrap: wrap; gap: 10px; }
        .world-tag-item { 
            background: var(--jj-light-green); 
            color: var(--jj-green); 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 14px; 
            display: inline-flex; 
            align-items: center; 
            border: 1px solid var(--jj-green);
        }
        .world-tag-close { margin-left: 8px; cursor: pointer; font-weight: bold; opacity: 0.6; }
        .world-tag-close:hover { opacity: 1; color: #ff4d4f; }

        /* å¢å¤§è¾“å…¥æ¡† */
        .large-input { padding: 12px; font-size: 15px; }
        .large-textarea { min-height: 120px; }

    </style>
</head>
<body>

    <nav class="navbar" id="mainNav">
        <div class="nav-item active" onclick="navTo('home')">
            <span class="nav-icon">âœ¨</span>åˆ›ä½œ
        </div>
        <div class="nav-item" onclick="navTo('bookshelf')">
            <span class="nav-icon">ğŸ“š</span>ä¹¦æ¶
        </div>
        <div class="nav-item" onclick="navTo('world')">
            <span class="nav-icon">ğŸŒ</span>ä¸–ç•Œè§‚
        </div>
        <div class="nav-item" onclick="navTo('settings')">
            <span class="nav-icon">âš™ï¸</span>è®¾ç½®
        </div>
    </nav>

    <div id="home" class="page active container">
        <div class="header-logo">æ™‹æ±Ÿæ–‡å­¦åŸ Â· AIè„‘æ´å·¥åŠ</div>
        
        <div class="card">
            <div class="input-group">
                <textarea id="promptInput" rows="3" placeholder="è¾“å…¥å…³é”®è¯ï¼ˆå¦‚ï¼šè¿½å¦»ç«è‘¬åœºï¼‰ã€æ¢—æ¦‚ï¼ˆå¦‚ï¼šä¸»è§’é‡ç”Ÿå›é«˜è€ƒå‰ï¼‰ï¼Œæˆ–ç‚¹å‡»ä¸‹æ–¹æ ‡ç­¾..."></textarea>
            </div>
            
            <div class="tag-cloud" id="homeTagCloud">
                <span class="tag-chip" onclick="addTag('å¼ºå¼º')">å¼ºå¼º</span>
                <span class="tag-chip" onclick="addTag('æ— é™æµ')">æ— é™æµ</span>
                <span class="tag-chip" onclick="addTag('ç³»ç»Ÿ')">ç³»ç»Ÿ</span>
            </div>
            
            <div style="margin-top: 15px; text-align: right;">
                <button class="btn btn-jj" onclick="startNewGeneration()">âœ¨ å¸®æˆ‘å†™æ–‡æ¡ˆ</button>
            </div>
        </div>

        <h3>ğŸ“š æ–°ä¹¦é€Ÿé€’</h3>
        <div id="generatedResults">
            <div style="text-align: center; color: #999; padding: 20px;">
                æš‚æ— ç”Ÿæˆè®°å½•ï¼Œè¯·åœ¨ä¸Šæ–¹è¾“å…¥çµæ„Ÿ...
            </div>
        </div>
        
        <div id="paginationControls" class="pagination-container" style="display:none;">
            <button class="btn btn-outline" id="btnPrev" onclick="changePage(-1)">ä¸Šä¸€é¡µ</button>
            <span class="page-num" id="pageIndicator">ç¬¬ 1 é¡µ</span>
            <button class="btn btn-jj" id="btnNext" onclick="generateNextPage()">ä¸‹ä¸€é¡µ ></button>
        </div>
    </div>

    <div id="detail" class="page container">
        <button class="btn btn-outline" onclick="navTo('home')" style="margin-bottom: 15px;">&larr; è¿”å›åˆ—è¡¨</button>
        
        <div class="card" id="bookDetailContent">
            </div>

        <div class="card">
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-jj" style="flex:1" onclick="addToShelf()">æ”¶è—æ­¤ä¹¦</button>
                <button class="btn btn-outline" style="flex:1" onclick="startReading(1)">å¼€å§‹é˜…è¯»</button>
            </div>
        </div>

        <div class="card">
            <h4 style="margin-top:0; color:var(--jj-green);">ç« èŠ‚ç›®å½•</h4>
            <div class="jj-chapter-list" id="chapterList">
                </div>
        </div>
    </div>

    <div id="reader" class="page container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <div style="display:flex; gap:10px;">
                <button class="btn btn-outline" onclick="navTo('detail')">&larr; è¯¦æƒ…</button>
                <button class="btn btn-outline" onclick="toggleReaderCatalog()">ğŸ“– ç›®å½•</button>
            </div>
            <button class="btn btn-danger" onclick="regenerateCurrentChapter()">â†» é‡æ–°ç”Ÿæˆ</button>
        </div>
        
        <!-- é˜…è¯»é¡µç›®å½•å¼¹çª— -->
        <div id="readerCatalogModal" class="catalog-modal" onclick="if(event.target===this) toggleReaderCatalog()">
            <div class="catalog-content">
                <div class="catalog-header">
                    <h3 style="margin:0; color:var(--jj-green);">ç« èŠ‚ç›®å½•</h3>
                    <button class="btn" onclick="toggleReaderCatalog()" style="font-size:20px; padding:0 10px;">Ã—</button>
                </div>
                <div id="readerCatalogList" class="catalog-list"></div>
            </div>
        </div>
        
        <div class="reader-content">
            <div id="readerTitle" class="reader-title"></div>
            <div id="readerBody"></div>
            
            <!-- ä½œè€…åè¯ -->
            <div class="author-say-box" id="authorSayBox" style="display:none;">
                <div class="author-say-header" onclick="toggleAuthorSay()">
                    <span>ğŸ“¢ ä½œè€…æœ‰è¯è¯´</span>
                    <span id="authorSayToggleIcon">â–¼</span>
                </div>
                <div class="author-say-content" id="authorSayContent"></div>
            </div>

            <!-- è¯»è€…è¯„è®º -->
            <div class="comment-section">
                <h4 style="color:var(--jj-green); margin-bottom:15px;">ğŸ“ è¯»è€…è¯„è®º</h4>
                <div id="commentList"></div>
                <div class="comment-action">
                    <button class="btn btn-outline" onclick="loadMoreComments()">æŸ¥çœ‹æ›´å¤šè¯„è®º</button>
                </div>
            </div>
        </div>

        <!-- æ–°å¢ï¼šå‰§æƒ…å»ºè®® -->
        <div class="card" style="margin-top: 15px; background: #f9f9f9;">
            <div class="input-group" style="margin-bottom: 0;">
                <label>ğŸ”® ä¸‹ä¸€ç« å‰§æƒ…å»ºè®® (AIæŒ‡ä»¤)</label>
                <textarea id="plotSuggestion" rows="2" placeholder="æƒ³çœ‹è¿½å¦»ç«è‘¬åœºï¼Ÿè¿˜æ˜¯ç»åœ°åå‡»ï¼Ÿå‘Šè¯‰AIä½ çš„æƒ³æ³•..."></textarea>
            </div>
        </div>

        <!-- æ–°å¢ï¼šç« èŠ‚æ‘˜è¦ -->
        <div class="card" style="margin-top: 15px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
                <h4 style="margin:0; color:var(--jj-green);">ğŸ“ æœ¬ç« æ‘˜è¦ (å‰æƒ…æè¦)</h4>
                <button class="btn btn-outline" onclick="autoGenerateSummary()" style="font-size:12px;">âœ¨ AIè‡ªåŠ¨æ€»ç»“</button>
            </div>
            <div style="font-size: 12px; color: #666; margin-bottom: 10px;">
                æ€»ç»“å°†ä½œä¸ºè®°å¿†ä¼ ç»™ä¸‹ä¸€ç« ã€‚è¯·éµå¾ªï¼šæµæ°´è´¦è®°å½•ã€åŒ…å«æ—¶é—´/äº‹ä»¶/ç»†èŠ‚/å¯¹è¯/æƒ…æ„Ÿå˜åŒ–ã€‚
            </div>
            <textarea id="chapterSummary" rows="8" placeholder="- æ—¶é—´:\n  - å…³é”®äº‹ä»¶: ..." oninput="saveChapterSummary()"></textarea>
        </div>

        <div style="display:flex; justify-content:space-between; margin-top:20px;">
            <button class="btn btn-outline" id="btnPrevChapter" onclick="prevChapter()">ä¸Šä¸€ç« </button>
            <button class="btn btn-jj" id="btnNextChapter" onclick="nextChapter()">ä¸‹ä¸€ç«  (AIåˆ›ä½œ)</button>
        </div>
    </div>

    <div id="bookshelf" class="page container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3>æˆ‘çš„æ”¶è—</h3>
            <div style="display: flex; gap: 5px;">
                <input type="file" id="importFile" style="display:none" onchange="importData(this)" accept=".json,.txt">
                <button class="btn btn-outline" onclick="document.getElementById('importFile').click()">å¯¼å…¥ä¹¦ç±</button>
                <button class="btn btn-outline" onclick="toggleBatchMode()" id="btnBatchMode">æ‰¹é‡ç®¡ç†</button>
            </div>
        </div>

        <div id="batchActions" style="display:none; background:#fff; padding:10px; margin-bottom:15px; border-radius:8px; border:1px solid var(--jj-green);">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; gap: 10px;">
                <span>å·²é€‰: <span id="selectedCount">0</span> æœ¬</span>
                <div style="display:flex; gap:5px; flex-wrap: wrap;">
                    <button class="btn btn-outline" onclick="exportSelectedData('json')">æ‰¹é‡å¯¼å‡ºJSON</button>
                    <button class="btn btn-outline" onclick="exportSelectedData('txt')">æ‰¹é‡å¯¼å‡ºTXT</button>
                    <button class="btn btn-danger" onclick="deleteSelectedBooks()">æ‰¹é‡åˆ é™¤</button>
                </div>
            </div>
        </div>

        <div class="input-group">
            <input type="text" id="shelfSearch" placeholder="æœç´¢ä¹¦å/æ ‡ç­¾..." oninput="renderShelf()">
        </div>

        <div class="bookshelf-grid" id="shelfGrid">
            </div>
    </div>

    <div id="world" class="page container">
        <h3>ğŸŒ ä¸–ç•Œè§‚ä¸è®¾å®šç®¡ç†</h3>
        
        <div class="world-tabs">
            <div class="world-tab-item active" data-tab="character" onclick="switchWorldTab('character')">è§’è‰²è®¾å®š</div>
            <div class="world-tab-item" data-tab="worldbook" onclick="switchWorldTab('worldbook')">ä¸–ç•Œä¹¦</div>
            <div class="world-tab-item" data-tab="tag" onclick="switchWorldTab('tag')">æ ‡ç­¾åŠŸèƒ½</div>
        </div>

        <!-- è§’è‰²è®¾å®šåŒºåŸŸ -->
        <div id="tab_content_character" class="world-tab-content">
            <div class="card">
                <div class="section-header">
                    <h4 style="margin:0">ğŸ‘¤ è§’è‰²è®¾å®š</h4>
                    <div class="btn-group">
                        <button class="btn btn-outline btn-sm" onclick="triggerImport('character')">å¯¼å…¥</button>
                        <button class="btn btn-outline btn-sm" onclick="exportWorldData('character')">å¯¼å‡º</button>
                        <button class="btn btn-danger btn-sm" onclick="clearWorldData('character')">æ¸…ç©º</button>
                    </div>
                </div>
                <!-- æ–°å»ºè¡¨å• -->
                <div class="add-form">
                    <div class="input-group">
                        <input type="text" id="new_character_name" class="large-input" placeholder="è§’è‰²å (å¦‚: æ—é»›ç‰)">
                    </div>
                    <div class="input-group">
                        <textarea id="new_character_desc" class="large-textarea" rows="5" placeholder="è§’è‰²æè¿°/äººè®¾/æ€§æ ¼/å¤–è²Œ"></textarea>
                    </div>
                    <button class="btn btn-jj" style="width:100%" onclick="addWorldItem('character')">æ–°å¢è§’è‰²</button>
                </div>
                <!-- åˆ—è¡¨ -->
                <div id="list_character" class="setting-list"></div>
            </div>
        </div>

        <!-- ä¸–ç•Œä¹¦åŒºåŸŸ -->
        <div id="tab_content_worldbook" class="world-tab-content" style="display:none">
            <div class="card">
                <div class="section-header">
                    <h4 style="margin:0">ğŸ“– ä¸–ç•Œä¹¦</h4>
                    <div class="btn-group">
                        <button class="btn btn-outline btn-sm" onclick="triggerImport('worldbook')">å¯¼å…¥</button>
                        <button class="btn btn-outline btn-sm" onclick="exportWorldData('worldbook')">å¯¼å‡º</button>
                        <button class="btn btn-danger btn-sm" onclick="clearWorldData('worldbook')">æ¸…ç©º</button>
                    </div>
                </div>
                <div class="add-form">
                    <div class="input-group">
                        <input type="text" id="new_worldbook_name" class="large-input" placeholder="æ¡ç›®åç§° (å¦‚: é­”æ³•ä½“ç³», åœ°ç†ç¯å¢ƒ)">
                    </div>
                    <div class="input-group">
                        <textarea id="new_worldbook_desc" class="large-textarea" rows="5" placeholder="è¯¦ç»†è®¾å®šè§„åˆ™"></textarea>
                    </div>
                    <button class="btn btn-jj" style="width:100%" onclick="addWorldItem('worldbook')">æ–°å¢è®¾å®š</button>
                </div>
                <div id="list_worldbook" class="setting-list"></div>
            </div>
        </div>

        <!-- æ ‡ç­¾åŒºåŸŸ -->
        <div id="tab_content_tag" class="world-tab-content" style="display:none">
            <div class="card">
                <div class="section-header">
                    <h4 style="margin:0">ğŸ·ï¸ æ ‡ç­¾</h4>
                    <div class="btn-group">
                        <button class="btn btn-outline btn-sm" onclick="triggerImport('tag')">å¯¼å…¥</button>
                        <button class="btn btn-outline btn-sm" onclick="exportWorldData('tag')">å¯¼å‡º</button>
                        <button class="btn btn-danger btn-sm" onclick="clearWorldData('tag')">æ¸…ç©º</button>
                    </div>
                </div>
                <div class="add-form">
                    <div class="input-group">
                        <input type="text" id="new_tag_name" class="large-input" placeholder="æ ‡ç­¾å (å¦‚: ç”œå® , å¼ºå¼º)">
                    </div>
                    <button class="btn btn-jj" style="width:100%" onclick="addWorldItem('tag')">æ–°å¢æ ‡ç­¾</button>
                </div>
                <div id="list_tag" class="setting-list tag-list-container"></div>
            </div>
        </div>

        <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† -->
        <input type="file" id="import_character" style="display:none" accept=".json" onchange="handleImport(this, 'character')">
        <input type="file" id="import_worldbook" style="display:none" accept=".json" onchange="handleImport(this, 'worldbook')">
        <input type="file" id="import_tag" style="display:none" accept=".json" onchange="handleImport(this, 'tag')">
    </div>

    <div id="settings" class="page container">
        <h3>âš™ï¸ ç³»ç»Ÿè®¾ç½®</h3>
        
        <!-- å…¨å±€æ•°æ®ç®¡ç† -->
        <div class="card">
            <h4>ğŸ’¾ å…¨å±€æ•°æ®ç®¡ç†</h4>
            <div style="background: #f9f9f9; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                <p style="font-size:13px; color:#666; margin-top:0;">å¤‡ä»½æˆ–æ¢å¤æ‰€æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬ä¹¦æ¶ã€ä¸–ç•Œè§‚ã€è®¾ç½®ã€é˜…è¯»å†å²ã€è¯„è®ºç­‰ï¼‰ã€‚</p>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-jj" style="flex:1" onclick="exportGlobalData()">ğŸ“¤ å¯¼å‡ºå…¨å±€å¤‡ä»½ (.json)</button>
                    <input type="file" id="importGlobalFile" style="display:none" accept=".json" onchange="importGlobalData(this)">
                    <button class="btn btn-outline" style="flex:1" onclick="document.getElementById('importGlobalFile').click()">ğŸ“¥ å¯¼å…¥å…¨å±€å¤‡ä»½</button>
                </div>
            </div>
        </div>

        <!-- æ ¸å¿ƒæŒ‡ä»¤åŒºåŸŸ -->
        <div class="card">
            <h4>ğŸ§  æ ¸å¿ƒæŒ‡ä»¤ä¸é¢„è®¾ç®¡ç†</h4>
            <div style="background: #f9f9f9; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                <div class="input-group">
                    <label>å½“å‰æ ¸å¿ƒæŒ‡ä»¤ (å…¨å±€æœ€é«˜ä¼˜å…ˆçº§)</label>
                    <textarea id="coreInstruction" rows="4" placeholder="åœ¨æ­¤è¾“å…¥å…¨å±€æŒ‡ä»¤ï¼Œä¾‹å¦‚ï¼š'æ‰€æœ‰ç”Ÿæˆå†…å®¹å¿…é¡»ç¬¦åˆæ™‹æ±Ÿæ–‡å­¦åŸå®¡æ ¸æ ‡å‡†ï¼Œä¸¥ç¦æ¶‰é»„æ¶‰æ”¿...'"></textarea>
                </div>
                <div style="display:flex; gap:10px; justify-content: flex-end;">
                    <button class="btn btn-jj" onclick="saveCoreInstruction()">ğŸ’¾ ä¿å­˜å½“å‰æŒ‡ä»¤</button>
                    <button class="btn btn-danger" onclick="clearCoreInstruction()">ğŸ—‘ï¸ æ¸…ç©º</button>
                </div>
            </div>

            <div class="input-group">
                <label>é¢„è®¾ç®¡ç†</label>
                <div style="display:flex; gap:10px; margin-bottom: 10px;">
                    <select id="corePresetsSelect" style="flex:1" onchange="loadCorePreset()">
                        <option value="">-- é€‰æ‹©é¢„è®¾ --</option>
                    </select>
                    <button class="btn btn-outline" onclick="saveAsCorePreset()">å­˜ä¸ºæ–°é¢„è®¾</button>
                    <button class="btn btn-danger" onclick="deleteCorePreset()">åˆ é™¤é¢„è®¾</button>
                </div>
                <div style="display:flex; gap:10px;">
                    <input type="file" id="importCorePresetFile" style="display:none" accept=".json" onchange="importCorePreset(this)">
                    <button class="btn btn-outline" style="flex:1" onclick="document.getElementById('importCorePresetFile').click()">ğŸ“¥ å¯¼å…¥é¢„è®¾</button>
                    <button class="btn btn-outline" style="flex:1" onclick="exportCorePreset()">ğŸ“¤ å¯¼å‡ºå½“å‰é¢„è®¾</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h4>ğŸ› ï¸ æ¨¡å‹é…ç½®ç®¡ç†</h4>
            <div style="background: #f9f9f9; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                <div class="input-group">
                    <label>å·²ä¿å­˜çš„é…ç½®</label>
                    <div style="display:flex; gap:10px;">
                        <select id="savedConfigs" style="flex:1" onchange="loadSelectedConfig()">
                            <option value="">-- æ–°å»ºé…ç½® --</option>
                        </select>
                        <button class="btn btn-danger" onclick="deleteConfig()">åˆ é™¤</button>
                    </div>
                </div>
                <div class="input-group">
                    <label>é…ç½®åç§°</label>
                    <input type="text" id="configName" placeholder="ç»™å½“å‰é…ç½®èµ·ä¸ªå (å¦‚: Gemini Flash é«˜é€Ÿç‰ˆ)">
                </div>
            </div>

            <h4>å½“å‰å‚æ•°è®¾ç½®</h4>
            <div class="input-group">
                <label>API URL (å¯é€‰ï¼Œé»˜è®¤ä¸ºå®˜æ–¹)</label>
                <input type="text" id="apiUrl" placeholder="ä¾‹å¦‚: https://generativelanguage.googleapis.com">
            </div>
            <div class="input-group">
                <label>API Key</label>
                <input type="password" id="apiKey" placeholder="åœ¨æ­¤è¾“å…¥ä½ çš„ API Key">
                <div style="margin-top: 5px;">
                    <input type="checkbox" onchange="toggleKeyVis(this)"> æ˜¾ç¤ºKey
                </div>
            </div>
            <div class="input-group">
                <label>æ¨¡å‹é€‰æ‹©</label>
                <div style="display:flex; gap:10px;">
                    <select id="modelSelect" style="flex:1">
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                    </select>
                    <button class="btn btn-outline" onclick="fetchModels()">æ‹‰å–æ¨¡å‹</button>
                </div>
            </div>
            <div style="display:flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-jj" style="flex:1" onclick="saveConfig()">ğŸ’¾ ä¿å­˜å¹¶åº”ç”¨é…ç½®</button>
                <button class="btn btn-outline" style="flex:1" onclick="applyConfigOnly()">âš¡ ä»…ä¸´æ—¶åº”ç”¨</button>
            </div>
        </div>
    </div>

    <script>
        // æ•°å­—è½¬ä¸­æ–‡å·¥å…·å‡½æ•°
        function toChineseNum(num) {
            const chnNumChar = ["é›¶", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­", "ä¸ƒ", "å…«", "ä¹"];
            const chnUnitSection = ["", "ä¸‡", "äº¿", "ä¸‡äº¿", "äº¿äº¿"];
            const chnUnitChar = ["", "å", "ç™¾", "åƒ"];
            const sectionToChinese = (section) => {
                let strIns = '', chnStr = '';
                let unitPos = 0;
                let zero = true;
                while (section > 0) {
                    let v = section % 10;
                    if (v === 0) {
                        if (!zero) {
                            zero = true;
                            chnStr = chnNumChar[v] + chnStr;
                        }
                    } else {
                        zero = false;
                        strIns = chnNumChar[v];
                        strIns += chnUnitChar[unitPos];
                        chnStr = strIns + chnStr;
                    }
                    unitPos++;
                    section = Math.floor(section / 10);
                }
                return chnStr;
            }
            let unitPos = 0;
            let strIns = '', chnStr = '';
            let needZero = false;
            if (num === 0) return chnNumChar[0];
            while (num > 0) {
                let section = num % 10000;
                if (needZero) chnStr = chnNumChar[0] + chnStr;
                strIns = sectionToChinese(section);
                strIns += (section !== 0) ? chnUnitSection[unitPos] : chnUnitSection[0];
                chnStr = strIns + chnStr;
                needZero = (section < 1000) && (section > 0);
                num = Math.floor(num / 10000);
                unitPos++;
            }
            if (chnStr.startsWith('ä¸€å')) chnStr = chnStr.substring(1);
            return chnStr;
        }

        // å®‰å…¨åŠ è½½ä¹¦æ¶æ•°æ®
        let initialBookshelf = [];
        try {
            initialBookshelf = JSON.parse(localStorage.getItem('jj_bookshelf')) || [];
        } catch (e) {
            console.error("ä¹¦æ¶æ•°æ®åŠ è½½å¤±è´¥ï¼Œé‡ç½®ä¸ºç©º", e);
            initialBookshelf = [];
        }

        const state = {
            currentBook: null,
            currentChapter: 1, // å½“å‰æ­£åœ¨é˜…è¯»çš„ç« èŠ‚å·
            bookshelf: initialBookshelf,
            worldSettings: JSON.parse(localStorage.getItem('jj_world')) || [],
            // æ–°å¢ï¼šç« èŠ‚å†…å®¹ç¼“å­˜ { bookId: { 1: "content...", 2: "content..." } }
            chapterCache: JSON.parse(localStorage.getItem('jj_chapter_cache')) || {},
            // æ–°å¢ï¼šç« èŠ‚æ ‡é¢˜ç¼“å­˜ { bookId: { 1: "Title", 2: "Title" } }
            chapterTitles: JSON.parse(localStorage.getItem('jj_chapter_titles')) || {},
            // æ–°å¢ï¼šç« èŠ‚æ‘˜è¦ç¼“å­˜
            chapterSummaries: JSON.parse(localStorage.getItem('jj_chapter_summaries')) || {},
            // æ–°å¢ï¼šåºŸå¼ƒç« èŠ‚ { bookId: { chapterNum: [ {content, authorSay, title, timestamp} ] } }
            abandonedChapters: JSON.parse(localStorage.getItem('jj_abandoned_chapters')) || {},
            // æ–°å¢ï¼šä½œè€…åè¯ç¼“å­˜ { bookId: { chapterNum: "..." } }
            authorSays: JSON.parse(localStorage.getItem('jj_author_says')) || {},
            // æ–°å¢ï¼šè¯„è®ºç¼“å­˜ { bookId: { chapterNum: [ {user, text, likes} ] } }
            comments: JSON.parse(localStorage.getItem('jj_comments')) || {},
            
            config: JSON.parse(localStorage.getItem('jj_config')) || {
                apiKey: '',
                model: 'gemini-1.5-flash',
                apiUrl: ''
            },
            configList: JSON.parse(localStorage.getItem('jj_config_list')) || [],
            // æ ¸å¿ƒæŒ‡ä»¤
            corePresets: JSON.parse(localStorage.getItem('jj_core_presets')) || [],
            currentCoreInstruction: localStorage.getItem('jj_current_core_instruction') || "",
            
            generatedPages: [],
            currentPageIndex: 0,
            lastPrompt: "",
            selectedBooks: new Set(),
            isBatchMode: false
        };

        // è¾…åŠ©å‡½æ•°ï¼šè·å–å¸¦æ ¸å¿ƒæŒ‡ä»¤çš„ Prompt
        function getFullPrompt(userPrompt) {
            const core = state.currentCoreInstruction ? `ã€æ ¸å¿ƒæŒ‡ä»¤ï¼ˆå…¨å±€æœ€é«˜ä¼˜å…ˆçº§ï¼Œå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰ã€‘ï¼š\n${state.currentCoreInstruction}\n\n----------------\n` : "";
            return core + userPrompt;
        }

        // è¾…åŠ©å‡½æ•°ï¼šä»æ–‡æœ¬ä¸­æå–ä¸–ç•Œè§‚è®¾å®š
        function getWorldContext(text) {
            if (!text) return "";
            let context = [];
            // ç®€å•çš„å…³é”®è¯åŒ¹é…ï¼Œå®é™…å¯ä¼˜åŒ–ä¸ºæ›´å¤æ‚çš„æ£€ç´¢
            state.worldSettings.forEach(item => {
                if (text.includes(item.name)) {
                    context.push(`ã€${item.type === 'character' ? 'è§’è‰²' : (item.type === 'worldbook' ? 'ä¸–ç•Œè®¾å®š' : 'æ ‡ç­¾')} - ${item.name}ã€‘ï¼š${item.desc}`);
                }
            });
            return context.join('\n');
        }

        // --- API è°ƒç”¨æ ¸å¿ƒå‡½æ•° ---
        async function callGeminiAPI(prompt, isJsonMode = false) {
            const apiKey = state.config.apiKey;
            if (!apiKey) throw new Error("æœªé…ç½® API Key");

            const model = state.config.model || 'gemini-1.5-flash';
            let baseUrl = state.config.apiUrl || 'https://generativelanguage.googleapis.com';
            
            // å¤„ç† baseUrl æ ¼å¼
            if(baseUrl.endsWith('/')) baseUrl = baseUrl.slice(0, -1);
            
            let url = baseUrl;
            // æ™ºèƒ½æ„å»º URL
            if (!url.includes(':generateContent')) {
                // å¦‚æœæ²¡æœ‰ /models è·¯å¾„ï¼Œå°è¯•æ„å»º
                if (!url.includes('/models')) {
                    // å¦‚æœæ²¡æœ‰ç‰ˆæœ¬å·ï¼Œé»˜è®¤ä½¿ç”¨ v1beta
                    if (!url.includes('/v1beta') && !url.includes('/v1')) {
                        url += '/v1beta';
                    }
                    url += '/models';
                }
                // æ·»åŠ æ¨¡å‹å’Œæ“ä½œ
                url += `/${model}:generateContent`;
            }

            const separator = url.includes('?') ? '&' : '?';
            const finalUrl = `${url}${separator}key=${apiKey}`;
            
            const payload = {
                contents: [{
                    parts: [{ text: prompt }]
                }]
            };

            // å¯ç”¨ JSON æ¨¡å¼ (Gemini 1.5 æ”¯æŒ)
            if (isJsonMode) {
                if (!payload.generationConfig) payload.generationConfig = {};
                payload.generationConfig.response_mime_type = "application/json";
            }

            try {
                const response = await fetch(finalUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(`API Error ${response.status}: ${errText}`);
                }

                const data = await response.json();
                if (!data.candidates || !data.candidates[0].content) {
                    throw new Error("API è¿”å›æ ¼å¼å¼‚å¸¸");
                }
                
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("API Call Failed:", error);
                throw error;
            }
        }

        function navTo(pageId) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            const navIndex = ['home', 'bookshelf', 'world', 'settings'].indexOf(pageId);
            if(navIndex !== -1) {
                document.getElementById('mainNav').style.display = 'flex';
                document.querySelectorAll('.nav-item')[navIndex].classList.add('active');
            } else if (pageId === 'reader') {
                document.getElementById('mainNav').style.display = 'none'; // é˜…è¯»æ¨¡å¼éšè—å¯¼èˆª
            }

            if (pageId === 'home') renderHomeTags();
            if (pageId === 'bookshelf') renderShelf();
            if (pageId === 'world') renderWorldPage();
            if (pageId === 'settings') loadSettingsUI();
        }

        function addTag(text) {
            const input = document.getElementById('promptInput');
            input.value += (input.value ? ' ' : '') + text;
        }

        function renderHomeTags() {
            const cloud = document.getElementById('homeTagCloud');
            const fixedTags = ['å¼ºå¼º', 'æ— é™æµ', 'ç³»ç»Ÿ', 'ç”œå® ', 'çˆ½æ–‡'];
            let html = fixedTags.map(t => `<span class="tag-chip" onclick="addTag('${t}')">${t}</span>`).join('');
            if(state.worldSettings.length > 0) {
                html += state.worldSettings.map(w => 
                    `<span class="tag-chip custom" onclick="addTag('${w.name}')">ğŸ“Œ${w.name}</span>`
                ).join('');
            }
            cloud.innerHTML = html;
        }

        function startNewGeneration() {
            state.generatedPages = [];
            state.currentPageIndex = 0;
            state.lastPrompt = document.getElementById('promptInput').value;
            generateBatch(true);
        }

        function generateNextPage() {
            if (state.currentPageIndex < state.generatedPages.length - 1) {
                changePage(1);
            } else {
                generateBatch(false);
            }
        }

        async function generateBatch(isFirstPage) {
            const prompt = state.lastPrompt;
            if(!prompt) return alert("è¯·è¾“å…¥ä¸€ç‚¹çµæ„Ÿå§ï¼");

            const resultsDiv = document.getElementById('generatedResults');
            const paginationControls = document.getElementById('paginationControls');
            
            if(isFirstPage) {
                resultsDiv.innerHTML = '<div style="text-align:center; padding:20px;">AIæ­£åœ¨ç–¯ç‹‚ç å­—ä¸­... </div>';
                paginationControls.style.display = 'none';
            } else {
                document.getElementById('btnNext').innerText = "ç”Ÿæˆä¸­...";
                document.getElementById('btnNext').disabled = true;
            }

            let books = [];
            if (state.config.apiKey) {
                 try {
                     const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªæ™‹æ±Ÿæ–‡å­¦åŸçš„å°è¯´ç”Ÿæˆå™¨ã€‚è¯·æ ¹æ®ç”¨æˆ·æä¾›çš„çµæ„Ÿï¼Œç”Ÿæˆ5æœ¬ä¸åŒé£æ ¼çš„å°è¯´è®¾å®šã€‚
                     è¿”å›æ ¼å¼å¿…é¡»æ˜¯çº¯ JSON æ•°ç»„ï¼Œä¸è¦åŒ…å« markdown ä»£ç å—æ ‡è®°ï¼ˆå¦‚ \`\`\`jsonï¼‰ã€‚
                     æ•°ç»„ä¸­æ¯ä¸ªå¯¹è±¡åŒ…å«ä»¥ä¸‹å­—æ®µï¼š
                     - id: éšæœºå”¯ä¸€æ•°å­—ID
                     - title: ä¹¦å
                     - author: ä½œè€…å
                     - genre: ç±»å‹ï¼ˆå¦‚ï¼šä»™ä¾ ä¿®çœŸã€ç°ä»£è¨€æƒ…ç­‰ï¼‰
                     - words: å­—æ•°ï¼ˆæ•°å­—ï¼Œ200000-1000000ä¹‹é—´ï¼‰
                     - score: è¯„åˆ†ï¼ˆå­—ç¬¦ä¸²ï¼Œå¦‚ "9.5"ï¼‰
                     - intro: ç®€ä»‹ï¼ˆ100å­—å·¦å³ï¼‰
                     - tags: æ ‡ç­¾æ•°ç»„ï¼ˆ3-5ä¸ªï¼‰
                     - status: å›ºå®šä¸º "å·²å®Œç»“"
                     - totalChapters: æ€»ç« èŠ‚æ•°ï¼ˆæ•°å­—ï¼Œ10-30ä¹‹é—´ï¼‰
                     - coverColor: å°é¢é¢œè‰²ï¼ˆCSSé¢œè‰²å€¼ï¼Œå¦‚ "#aaffcc" æˆ– "hsl(120, 50%, 80%)"ï¼‰
                     `;
                     
                     const userPrompt = `çµæ„Ÿå…³é”®è¯ï¼š${prompt}`;
                     
                     // æ³¨å…¥ä¸–ç•Œè§‚ä¸Šä¸‹æ–‡
                     const worldContext = getWorldContext(prompt);
                     const contextPrompt = worldContext ? `\n\nã€æ£€æµ‹åˆ°å…³è”çš„ä¸–ç•Œè§‚/è§’è‰²è®¾å®šï¼Œè¯·åœ¨ç”Ÿæˆæ—¶åŠ¡å¿…å‚è€ƒå¹¶ä½“ç°ä»¥ä¸‹ä¿¡æ¯ã€‘ï¼š\n${worldContext}` : "";
                     
                     const fullPrompt = `${systemPrompt}\n\n${userPrompt}${contextPrompt}`;
                     
                     const jsonStr = await callGeminiAPI(getFullPrompt(fullPrompt), true);
                     // æ¸…ç†å¯èƒ½å­˜åœ¨çš„ markdown æ ‡è®°
                     const cleanJson = jsonStr.replace(/```json/g, '').replace(/```/g, '').trim();
                     books = JSON.parse(cleanJson);
                     
                     // å®¹é”™å¤„ç†ï¼šç¡®ä¿æ˜¯æ•°ç»„
                     if(!Array.isArray(books)) books = [books];
                     
                 } catch(e) {
                     console.error(e);
                     alert("APIè°ƒç”¨å¤±è´¥ï¼Œå·²åˆ‡æ¢å›æ¨¡æ‹Ÿæ•°æ®ã€‚\né”™è¯¯ä¿¡æ¯: " + e.message);
                     books = mockAIResponse(prompt, state.generatedPages.length + 1);
                 }
            } else {
                await new Promise(r => setTimeout(r, 800));
                books = mockAIResponse(prompt, state.generatedPages.length + 1);
            }

            state.generatedPages.push(books);
            state.currentPageIndex = state.generatedPages.length - 1;
            renderCurrentPage();
        }

        function renderCurrentPage() {
            const books = state.generatedPages[state.currentPageIndex];
            const container = document.getElementById('generatedResults');
            
            container.innerHTML = books.map(book => `
                <div class="book-preview-item" onclick='showBookDetail(${JSON.stringify(book).replace(/'/g, "&#39;")})'>
                    <div class="book-info">
                        <h3>${book.title}</h3>
                        <div class="book-meta">
                            [${book.genre}] | ${book.author} | ${book.score}åˆ† | ${(book.words/10000).toFixed(1)}ä¸‡å­— | <span style="color:darkred">å·²å®Œç»“</span>
                        </div>
                        <div class="book-intro">${book.intro}</div>
                    </div>
                </div>
            `).join('');

            document.getElementById('paginationControls').style.display = 'flex';
            document.getElementById('pageIndicator').innerText = `ç¬¬ ${state.currentPageIndex + 1} é¡µ`;
            document.getElementById('btnPrev').disabled = (state.currentPageIndex === 0);
            const btnNext = document.getElementById('btnNext');
            btnNext.innerText = "ä¸‹ä¸€é¡µ >";
            btnNext.disabled = false;
        }

        function changePage(delta) {
            const newIndex = state.currentPageIndex + delta;
            if (newIndex >= 0 && newIndex < state.generatedPages.length) {
                state.currentPageIndex = newIndex;
                renderCurrentPage();
            }
        }

        // ä¿®æ”¹ï¼šæ›´æ–°ä¹¦ç±å±æ€§ (å®Œç»“çŠ¶æ€, éšæœºç« èŠ‚)
        function mockAIResponse(prompt, pageNum) {
            const seed = Date.now();
            const genres = ["ä»™ä¾ ä¿®çœŸ", "ç°ä»£è¨€æƒ…", "å¹»æƒ³æœªæ¥", "æ‚¬ç–‘æƒŠæ‚š", "å¤æ—©ç‹—è¡€"];
            
            const prefixes = ["é‡ç”Ÿä¹‹", "ç©¿è¶Šå", "éœ‡æƒŠï¼", "ç©¿ä¹¦ä¹‹", "å¼€å±€", "ç»ä¸–", "è±ªé—¨", "æˆ‘åœ¨å¼‚ç•Œ", "æœ«ä¸–ä¹‹"];
            const suffixes = ["æ”»ç•¥", "æ—¥å¸¸", "æŒ‡å—", "è‡ªæ•‘ç³»ç»Ÿ", "ä¿®ä»™å½•", "å¤§å†’é™©", "ç”Ÿå­˜æ‰‹æœ­", "ä¸æƒ³åŠªåŠ›äº†"];
            const midFixes = ["å¤§ä½¬", "åæ´¾", "ç‚®ç°", "å¸ˆå°Š", "æ€»è£", "å½±å¸"];

            let mockBooks = [];
            const cleanPrompt = prompt.length > 5 ? prompt.substring(0, 4) + "..." : prompt;

            for(let i=0; i<5; i++) {
                const uniqueId = seed + i;
                let randTitle = "";
                const r = Math.random();
                if(r < 0.3) {
                    randTitle = prefixes[i % prefixes.length] + cleanPrompt;
                } else if (r < 0.6) {
                    randTitle = cleanPrompt + suffixes[i % suffixes.length];
                } else {
                    randTitle = cleanPrompt + "ä¸" + midFixes[i % midFixes.length] + "çš„" + suffixes[i % suffixes.length];
                }
                randTitle += (pageNum > 1 ? (" " + pageNum) : "");

                // ä¿®æ”¹ï¼šéšæœºç”Ÿæˆ 1-25 ç« 
                const totalChaps = Math.floor(Math.random() * 25) + 1;

                mockBooks.push({
                    id: uniqueId,
                    title: randTitle,
                    author: "æ™‹æ±ŸAI-" + Math.floor(Math.random()*100),
                    genre: genres[(i + pageNum) % genres.length],
                    words: Math.floor(Math.random() * 500000) + 200000,
                    score: (Math.random() * 2 + 8).toFixed(1),
                    intro: `è¿™æ˜¯åŸºäºå…³é”®è¯â€œ${prompt}â€ç”Ÿæˆçš„æ–‡æ¡ˆã€‚\nä¸»è§’åœ¨${prompt}çš„ä¸–ç•Œé‡Œæ‘¸çˆ¬æ»šæ‰“ï¼Œæœ€ç»ˆæˆä¸ºä¸€ä»£ä¼ å¥‡ã€‚\nè¿™é‡Œæ˜¯ç”Ÿæˆçš„ç®€ä»‹ç»†èŠ‚å¡«å……...`,
                    tags: [prompt, "çˆ½æ–‡", "HE"],
                    status: "å·²å®Œç»“", // ä¿®æ”¹ï¼šå›ºå®šä¸ºå·²å®Œç»“
                    totalChapters: totalChaps, // ä¿®æ”¹ï¼šä¿å­˜ç« èŠ‚æ€»æ•°
                    coverColor: `hsl(${(seed * (i+1)) % 360}, 70%, 85%)`
                });
            }
            return mockBooks;
        }

        // ä¿®æ”¹ï¼šè¯¦æƒ…é¡µåŠ¨æ€æ¸²æŸ“ç« èŠ‚
        function showBookDetail(book) {
            state.currentBook = book;
            const content = document.getElementById('bookDetailContent');
            const chapterList = document.getElementById('chapterList');

            // ä¿®æ”¹ï¼šæ˜¾ç¤ºâ€œå·²å®Œç»“â€å’Œçº¢è‰²å­—ä½“
            content.innerHTML = `
                <div class="jj-detail-header">
                    <div class="jj-cover-lg" style="background:${book.coverColor || '#f0f0f0'}">
                        <div style="font-size:18px; font-weight:bold;">${book.title}</div>
                        <div style="font-size:12px; margin-top:10px;">${book.author} è‘—</div>
                    </div>
                    <div class="jj-meta-info">
                        <h1>${book.title} <span style="font-size:14px; color:gold;">VIP</span></h1>
                        <div class="jj-stat-row">ä½œè€…ï¼š${book.author}</div>
                        <div class="jj-stat-row">ç±»å‹ï¼š${book.genre}</div>
                        <div class="jj-stat-row">è¿›åº¦ï¼š<span style="color:darkred; font-weight:bold;">å·²å®Œç»“</span></div>
                        <div class="jj-stat-row">å…¨æ–‡å­—æ•°ï¼š${book.words} å­—</div>
                        <div class="jj-stat-row">ç« èŠ‚æ•°ï¼š${book.totalChapters} ç« </div>
                        <div class="jj-stat-row">è¯„åˆ†ï¼šâ­â­â­â­â­ ${book.score}</div>
                    </div>
                </div>
                <div class="jj-copy-box">${book.intro}</div>
                <div class="jj-tags">
                    <b>å†…å®¹æ ‡ç­¾ï¼š</b> ${book.tags.map(t => `<span class="jj-tag-item">[${t}]</span>`).join(' ')}
                </div>
            `;
            
            // ä¿®æ”¹ï¼šæ ¹æ® totalChapters å¾ªç¯ç”Ÿæˆç« èŠ‚åˆ—è¡¨
            let chapterHtml = '';
            const abandonedData = state.abandonedChapters[book.id] || {};

            for(let i = 1; i <= book.totalChapters; i++) {
                // å‰3ç« å…è´¹ï¼Œåé¢VIP
                const isVip = i > 3;
                chapterHtml += `
                    <div class="jj-chapter-row" onclick="startReading(${i})">
                        <span>ç¬¬${toChineseNum(i)}ç«  ${isVip ? 'VIPç« èŠ‚' : 'å…è´¹ç« èŠ‚'}</span>
                        <span class="${isVip ? 'jj-vip' : ''}">${isVip ? 'VIP' : 'å…è´¹'}</span>
                    </div>
                `;
                
                // æ˜¾ç¤ºåºŸå¼ƒç« èŠ‚
                if (abandonedData[i] && abandonedData[i].length > 0) {
                    abandonedData[i].forEach((item, idx) => {
                        const dateStr = new Date(item.timestamp).toLocaleString();
                        chapterHtml += `
                            <div class="abandoned-chapter-row" onclick="readAbandonedChapter(${i}, ${idx})">
                                <span><span class="abandoned-tag">åºŸå¼ƒ</span> ç‰ˆæœ¬ ${idx + 1} (${dateStr})</span>
                                <span>ğŸ—‘ï¸</span>
                            </div>
                        `;
                    });
                }
            }
            chapterList.innerHTML = chapterHtml;
            
            navTo('detail');
        }

        // --- é˜…è¯»å™¨é€»è¾‘ (å¤§å¹…æ›´æ–°) ---

        // è¿›å…¥é˜…è¯»æ¨¡å¼
        // forceRegenerate: æ˜¯å¦å¼ºåˆ¶é‡æ–°ç”Ÿæˆ
        // suggestion: ç”¨æˆ·ç»™å‡ºçš„å‰§æƒ…å»ºè®®
        // prevSummary: ä¸Šä¸€ç« çš„æ‘˜è¦ï¼ˆç”¨äºç”Ÿæˆæœ¬ç« çš„ä¸Šä¸‹æ–‡ï¼‰
        async function startReading(chapterNum, forceRegenerate = false, suggestion = "", prevSummary = "") {
            if(!state.currentBook) return;
            state.currentChapter = chapterNum;
            navTo('reader');
            
            const bookId = state.currentBook.id;
            const titleEl = document.getElementById('readerTitle');
            const bodyEl = document.getElementById('readerBody');
            const authorSayBox = document.getElementById('authorSayBox');
            const authorSayContent = document.getElementById('authorSayContent');
            const commentList = document.getElementById('commentList');
            
            // é»˜è®¤æ ‡é¢˜
            let displayTitle = `ç¬¬${toChineseNum(chapterNum)}ç« `;
            
            // å°è¯•ä»ç¼“å­˜è·å–æ ‡é¢˜
            if (state.chapterTitles[bookId] && state.chapterTitles[bookId][chapterNum]) {
                let t = state.chapterTitles[bookId][chapterNum];
                // æ¸…æ´—æ ‡é¢˜ï¼Œå»é™¤å¯èƒ½å­˜åœ¨çš„ "ç¬¬xç« " å‰ç¼€
                t = t.replace(/^ç¬¬[0-9é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒ]+ç« \s*/, '');
                displayTitle += ` ${t}`;
            }
            
            titleEl.innerText = displayTitle;
            authorSayBox.style.display = 'none';
            authorSayContent.innerHTML = '';
            commentList.innerHTML = '';

            // åŠ è½½æœ¬ç« æ‘˜è¦ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (!state.chapterSummaries[bookId]) state.chapterSummaries[bookId] = {};
            document.getElementById('chapterSummary').value = state.chapterSummaries[bookId][chapterNum] || "";
            
            // æ¸…ç©ºå»ºè®®æ¡†
            document.getElementById('plotSuggestion').value = "";

            // æ£€æŸ¥ç¼“å­˜
            if (!state.chapterCache[bookId]) state.chapterCache[bookId] = {};
            if (!state.chapterTitles[bookId]) state.chapterTitles[bookId] = {};
            if (!state.authorSays[bookId]) state.authorSays[bookId] = {};
            if (!state.comments[bookId]) state.comments[bookId] = {};

            // å¦‚æœæœ‰ç¼“å­˜ä¸”ä¸æ˜¯å¼ºåˆ¶é‡æ–°ç”Ÿæˆï¼Œç›´æ¥æ˜¾ç¤ºç¼“å­˜
            if (!forceRegenerate && state.chapterCache[bookId][chapterNum]) {
                bodyEl.innerHTML = state.chapterCache[bookId][chapterNum];
                
                // æ˜¾ç¤ºç¼“å­˜çš„ä½œè€…åè¯
                if (state.authorSays[bookId][chapterNum]) {
                    authorSayContent.innerText = state.authorSays[bookId][chapterNum];
                    authorSayBox.style.display = 'block';
                }
                
                // æ˜¾ç¤ºç¼“å­˜çš„è¯„è®º
                renderComments(bookId, chapterNum);
                if (!state.comments[bookId][chapterNum] || state.comments[bookId][chapterNum].length === 0) {
                    loadMoreComments(); // å¦‚æœæ²¡æœ‰è¯„è®ºï¼Œè‡ªåŠ¨åŠ è½½ä¸€æ¬¡
                }

                updateNavButtons();
                return;
            }

            // å¦åˆ™è¿›è¡Œç”Ÿæˆ
            bodyEl.innerHTML = "<p style='color:#999; text-align:center;'>AI æ­£åœ¨æ ¹æ®äººè®¾å’Œä¸–ç•Œè§‚ä¸ºæ‚¨å®æ—¶æ’°å†™æœ¬ç« å†…å®¹ï¼Œè¯·ç¨å€™...</p>";
            updateNavButtons(true); // ç”Ÿæˆä¸­ç¦ç”¨æŒ‰é’®

            const result = await fetchChapterContent(state.currentBook, chapterNum, suggestion, prevSummary);
            
            // æ›´æ–°æ ‡é¢˜
            if (result.title) {
                let t = result.title;
                // æ¸…æ´—æ ‡é¢˜ï¼Œå»é™¤å¯èƒ½å­˜åœ¨çš„ "ç¬¬xç« " å‰ç¼€
                t = t.replace(/^ç¬¬[0-9é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒ]+ç« \s*/, '');
                
                state.chapterTitles[bookId][chapterNum] = t;
                localStorage.setItem('jj_chapter_titles', JSON.stringify(state.chapterTitles));
                titleEl.innerText = `ç¬¬${toChineseNum(chapterNum)}ç«  ${t}`;
            }

            // ç®€å•çš„æ‰“å­—æœºæ•ˆæœ
            bodyEl.innerHTML = "";
            const paragraphs = result.content.split('\n');
            let fullHtml = "";
            for(let p of paragraphs) {
                if(p.trim()) {
                    const pHtml = `<p>${p}</p>`;
                    fullHtml += pHtml;
                    const pTag = document.createElement('p');
                    pTag.innerText = p;
                    bodyEl.appendChild(pTag);
                    await new Promise(r => setTimeout(r, 20)); 
                }
            }

            // å­˜å…¥ç¼“å­˜
            state.chapterCache[bookId][chapterNum] = fullHtml;
            localStorage.setItem('jj_chapter_cache', JSON.stringify(state.chapterCache));
            
            // å¤„ç†ä½œè€…åè¯
            if (result.authorSay) {
                state.authorSays[bookId][chapterNum] = result.authorSay;
                localStorage.setItem('jj_author_says', JSON.stringify(state.authorSays));
                authorSayContent.innerText = result.authorSay;
                authorSayBox.style.display = 'block';
            }

            // å¤„ç†AIç”Ÿæˆçš„è¯„è®º
            if (result.commentsRaw) {
                const lines = result.commentsRaw.split('\n').filter(l => l.trim());
                const newComments = lines.map(line => {
                    const parts = line.split(/[:ï¼š]/);
                    const user = parts[0].trim();
                    const text = parts.slice(1).join(':').trim();
                    return {
                        user: user || "åŒ¿åè¯»è€…",
                        text: text || line,
                        likes: Math.floor(Math.random() * 100)
                    };
                });
                
                if (!state.comments[bookId]) state.comments[bookId] = {};
                // è¦†ç›–æˆ–è¿½åŠ ï¼Ÿè¿™é‡Œé€‰æ‹©è¦†ç›–åˆå§‹è¯„è®ºï¼Œå› ä¸ºæ˜¯æ–°ç”Ÿæˆçš„
                state.comments[bookId][chapterNum] = newComments;
                localStorage.setItem('jj_comments', JSON.stringify(state.comments));
                renderComments(bookId, chapterNum);
            } else {
                // å¦‚æœæ²¡æœ‰AIè¯„è®ºï¼Œå°è¯•åŠ è½½æ›´å¤šï¼ˆå¯èƒ½ä¼šè§¦å‘APIç”Ÿæˆæˆ–æ¨¡æ‹Ÿï¼‰
                loadMoreComments();
            }

            updateNavButtons();
        }

        async function fetchChapterContent(book, chapterNum, suggestion, prevSummary) {
            // æå–ä¸Šä¸‹æ–‡ï¼šä¹¦åã€ç®€ä»‹ã€æ ‡ç­¾
            const contextText = `${book.title} ${book.intro} ${book.tags.join(' ')}`;
            const worldContext = getWorldContext(contextText);

            const prompt = `è¯·ä¸ºå°è¯´ã€Š${book.title}ã€‹å†™ç¬¬${chapterNum}ç« çš„å†…å®¹ã€‚
            å°è¯´ç±»å‹ï¼š${book.genre}ã€‚
            ç®€ä»‹ï¼š${book.intro}ã€‚
            
            ${worldContext ? `ã€ä¸–ç•Œè§‚ä¸è§’è‰²è®¾å®šï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰ã€‘ï¼š\n${worldContext}\n` : ''}
            ${prevSummary ? `ã€å‰æƒ…æè¦ã€‘ï¼š\n${prevSummary}\n` : ''}
            ${suggestion ? `ã€å‰§æƒ…èµ°å‘å»ºè®®ã€‘ï¼š\n${suggestion}\n` : ''}

            è¦æ±‚ï¼š
            1. ç¬¬ä¸€è¡Œå¿…é¡»æ˜¯ç« èŠ‚æ ‡é¢˜ï¼Œæ ¼å¼ä¸º "TITLE: [æ ‡é¢˜å†…å®¹]"ã€‚
            2. æ™‹æ±Ÿæ–‡å­¦åŸç½‘æ–‡é£æ ¼ï¼Œæå†™ç»†è…»ï¼Œå¯¹è¯ç”ŸåŠ¨ï¼Œ1000å­—å·¦å³ã€‚
            3. å‰§æƒ…è¿è´¯ã€‚
            4. åœ¨æ­£æ–‡ç»“æŸåï¼Œå¿…é¡»å¦èµ·ä¸€è¡Œï¼Œè¾“å‡ºåˆ†éš”ç¬¦ "=== AUTHOR_SAY ==="ã€‚
            5. åœ¨åˆ†éš”ç¬¦åï¼Œå†™ä¸€æ®µâ€œä½œè€…æœ‰è¯è¯´â€ï¼šåŒ…å«å¯¹æœ¬ç« æƒ…èŠ‚çš„å®‰æ’æ¢³ç†ã€å¯¹äººç‰©è§’è‰²çš„è¯„ä»·ã€å¯¹ä¸‹ä¸€ç« èŠ‚çš„å†…å®¹é¢„å‘Šã€‚è¯­æ°”è¦äº²åˆ‡ï¼Œåƒä½œè€…å’Œè¯»è€…èŠå¤©ã€‚
            6. åœ¨â€œä½œè€…æœ‰è¯è¯´â€ç»“æŸåï¼Œå¿…é¡»å¦èµ·ä¸€è¡Œï¼Œè¾“å‡ºåˆ†éš”ç¬¦ "=== COMMENTS ==="ã€‚
            7. åœ¨åˆ†éš”ç¬¦åï¼Œç”Ÿæˆ 5 æ¡è¯»è€…è¯„è®ºï¼Œæ¯è¡Œä¸€æ¡ï¼Œæ ¼å¼ä¸º "ç”¨æˆ·ID: è¯„è®ºå†…å®¹"ã€‚
               - è¯„è®ºå¿…é¡»ç´§æ‰£æœ¬ç« çš„å…·ä½“å‰§æƒ…ã€äººç‰©å¯¹è¯æˆ–ç»†èŠ‚ï¼Œä¸¥ç¦ç”Ÿæˆé€šç”¨çš„â€œå¥½çœ‹â€ã€â€œæ‰“å¡â€ç­‰æ— æ„ä¹‰è¯„è®ºã€‚
               - æ¨¡æ‹ŸçœŸå®çš„æ™‹æ±Ÿè¯»è€…è¯­æ°”ï¼Œé£æ ¼è¦å¤šæ ·åŒ–ï¼šæœ‰çš„å°–å«æŠ“ç‹‚ï¼ˆå¯å¸¦emojiï¼‰ï¼Œæœ‰çš„ç†æ€§åˆ†æä¼ç¬”ï¼Œæœ‰çš„åæ§½äººç‰©æ“ä½œï¼Œæœ‰çš„ç©æ¢—ã€‚
               - è¯„è®ºå†…å®¹ä¸è¦é‡å¤ï¼Œä¸è¦åŒè´¨åŒ–ã€‚
            8. **é‡è¦ï¼šä¸è¦ä½¿ç”¨ Markdown æ ¼å¼ï¼ˆå¦‚ **åŠ ç²—**ï¼‰ï¼Œè¯·ç›´æ¥è¾“å‡ºçº¯æ–‡æœ¬ã€‚**

            æ ¼å¼ç¤ºä¾‹ï¼š
            TITLE: ç« èŠ‚æ ‡é¢˜
            [æ­£æ–‡å†…å®¹...]
            
            === AUTHOR_SAY ===
            [ä½œè€…æœ‰è¯è¯´å†…å®¹...]
            
            === COMMENTS ===
            ç”¨æˆ·A: è¯„è®ºå†…å®¹...
            ç”¨æˆ·B: è¯„è®ºå†…å®¹...`;

            let rawText = "";
            if (state.config.apiKey) {
                try {
                     rawText = await callGeminiAPI(getFullPrompt(prompt));
                } catch(e) {
                     rawText = "ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–Keyé…ç½®ã€‚\né”™è¯¯ä¿¡æ¯: " + e.message + "\n\n(ä»¥ä¸‹æ˜¯æ¨¡æ‹Ÿå†…å®¹)\nTITLE: æ¨¡æ‹Ÿç« èŠ‚æ ‡é¢˜\n" + mockChapterText(chapterNum, book);
                }
            } else {
                await new Promise(r => setTimeout(r, 1000));
                rawText = "TITLE: å‘½è¿çš„é½¿è½®\n" + mockChapterText(chapterNum, book) + "\n\n=== AUTHOR_SAY ===\nï¼ˆæ¨¡æ‹Ÿï¼‰ä½œè€…æœ‰è¯è¯´ï¼šæœ¬ç« å‰§æƒ…ç¨å¾®æœ‰ç‚¹è™ï¼Œå¤§å®¶æŒºä½ï¼ä¸‹ä¸€ç« ä¸»è§’å°±è¦å¼€å§‹åå‡»äº†ï¼Œæ•¬è¯·æœŸå¾…ï¼æ±‚æ”¶è—æ±‚è¯„è®º~\n\n=== COMMENTS ===\nç”¨æˆ·1: æ¨¡æ‹Ÿè¯„è®º1\nç”¨æˆ·2: æ¨¡æ‹Ÿè¯„è®º2";
            }

            // è§£ææ ‡é¢˜ã€æ­£æ–‡ã€ä½œè€…åè¯å’Œè¯„è®º
            let title = "";
            let content = rawText;
            
            // æå–æ ‡é¢˜
            const titleMatch = content.match(/^TITLE:\s*(.*)/i);
            if (titleMatch) {
                title = titleMatch[1].trim();
                content = content.replace(/^TITLE:.*\n?/i, '').trim();
            }

            const parts = content.split('=== AUTHOR_SAY ===');
            const bodyContent = parts[0].trim();
            let authorSay = "";
            let commentsRaw = "";

            if (parts.length > 1) {
                const subParts = parts[1].split('=== COMMENTS ===');
                authorSay = subParts[0].trim();
                if (subParts.length > 1) {
                    commentsRaw = subParts[1].trim();
                }
            }

            return {
                title: title,
                content: bodyContent,
                authorSay: authorSay || "ï¼ˆä½œè€…å¤ªç´¯äº†ï¼Œæ²¡æœ‰ç•™ä¸‹åè¯ï¼‰",
                commentsRaw: commentsRaw
            };
        }

        function mockChapterText(chapterNum, book) {
            return `    ç¬¬${chapterNum}ç« çš„é’Ÿå£°æ•²å“äº†ã€‚\n
    å¯¹äº${book.title}ä¸­çš„ä¸»è§’æ¥è¯´ï¼Œè¿™åˆæ˜¯æ–°çš„ä¸€å¤©ã€‚åœ¨ç»å†äº†å‰å‡ ç« çš„æ³¢æŠ˜åï¼Œå‰§æƒ…æ¥åˆ°äº†ç¬¬${chapterNum}ç« çš„å…³é”®èŠ‚ç‚¹ã€‚\n
    å‘¨å›´çš„ç¯å¢ƒå‘ç”Ÿäº†ä¸€äº›å¾®å¦™çš„å˜åŒ–ï¼Œä»¿ä½›é¢„ç¤ºç€æ¥ä¸‹æ¥çš„æ•…äº‹å°†æ›´åŠ æ‰£äººå¿ƒå¼¦ã€‚${book.genre}ä¸–ç•Œçš„è§„åˆ™ä¾ç„¶åœ¨å†·é…·åœ°è¿è½¬ã€‚\n
    â€œæˆ‘ä»¬ä¸èƒ½åœä¸‹ã€‚â€é…è§’åœ¨ä¸€æ—è¯´é“ï¼Œç¥è‰²å‡é‡ã€‚\n
    ä¸»è§’ç‚¹äº†ç‚¹å¤´ï¼Œçœ‹å‘è¿œæ–¹ï¼šâ€œæˆ‘çŸ¥é“ï¼Œè¿™åªæ˜¯åˆšåˆšå¼€å§‹ã€‚â€\n
    ï¼ˆæ­¤å¤„ä¸ºAIç”Ÿæˆçš„æ¨¡æ‹Ÿæ­£æ–‡å†…å®¹ã€‚ç³»ç»Ÿå·²å°†æœ¬ç« å†…å®¹ç¼“å­˜ï¼Œæ‚¨ç‚¹å‡»ä¸Šä¸€ç« å†å›æ¥ï¼Œå†…å®¹ä¾ç„¶æ˜¯è¿™æ®µã€‚ç‚¹å‡»å³ä¸Šè§’â€œé‡æ–°ç”Ÿæˆâ€å¯è¦†ç›–æ­¤å†…å®¹ã€‚ï¼‰\n
    éšç€æ—¶é—´çš„æ¨ç§»ï¼ŒçœŸç›¸ä¼¼ä¹è¶Šæ¥è¶Šè¿‘ï¼Œåˆä¼¼ä¹è¶Šæ¥è¶Šè¿œã€‚å‘½è¿çš„é½¿è½®è¿˜åœ¨è½¬åŠ¨ï¼Œè°ä¹Ÿæ— æ³•é¢„çŸ¥ç»“å±€ã€‚`;
        }

        // ä¸Šä¸€ç« 
        function prevChapter() {
            if(state.currentChapter > 1) {
                startReading(state.currentChapter - 1);
            }
        }

        // ä¸‹ä¸€ç« 
        function nextChapter() {
            if(state.currentChapter < state.currentBook.totalChapters) {
                const suggestion = document.getElementById('plotSuggestion').value;
                const currentSummary = document.getElementById('chapterSummary').value;
                startReading(state.currentChapter + 1, false, suggestion, currentSummary);
            }
        }

        // é‡æ–°ç”Ÿæˆå½“å‰ç« 
        function regenerateCurrentChapter() {
            if(confirm("ç¡®å®šè¦é‡æ–°ç”Ÿæˆæœ¬ç« å†…å®¹å—ï¼Ÿå½“å‰ç‰ˆæœ¬å°†ç§»å…¥åºŸå¼ƒç›®å½•ã€‚")) {
                const bookId = state.currentBook.id;
                const chapterNum = state.currentChapter;
                
                // ä¿å­˜å½“å‰ç‰ˆæœ¬åˆ°åºŸå¼ƒåˆ—è¡¨
                if (state.chapterCache[bookId] && state.chapterCache[bookId][chapterNum]) {
                    if (!state.abandonedChapters[bookId]) state.abandonedChapters[bookId] = {};
                    if (!state.abandonedChapters[bookId][chapterNum]) state.abandonedChapters[bookId][chapterNum] = [];
                    
                    state.abandonedChapters[bookId][chapterNum].push({
                        content: state.chapterCache[bookId][chapterNum],
                        authorSay: state.authorSays[bookId] ? state.authorSays[bookId][chapterNum] : "",
                        title: state.chapterTitles[bookId] ? state.chapterTitles[bookId][chapterNum] : "",
                        timestamp: Date.now()
                    });
                    localStorage.setItem('jj_abandoned_chapters', JSON.stringify(state.abandonedChapters));
                }

                const suggestion = document.getElementById('plotSuggestion').value;
                const prevSummary = state.chapterSummaries[bookId]?.[state.currentChapter - 1] || "";
                startReading(state.currentChapter, true, suggestion, prevSummary);
            }
        }

        // é˜…è¯»åºŸå¼ƒç« èŠ‚
        function readAbandonedChapter(chapterNum, index) {
            const bookId = state.currentBook.id;
            const item = state.abandonedChapters[bookId][chapterNum][index];
            if (!item) return;

            navTo('reader');
            
            let displayTitle = `ç¬¬${toChineseNum(chapterNum)}ç« `;
            if (item.title) displayTitle += ` ${item.title}`;
            displayTitle += ` (åºŸå¼ƒç‰ˆæœ¬ ${index + 1})`;
            
            document.getElementById('readerTitle').innerText = displayTitle;
            document.getElementById('readerBody').innerHTML = item.content;
            
            // æ˜¾ç¤ºåºŸå¼ƒç‰ˆæœ¬çš„ä½œè€…åè¯
            const authorSayBox = document.getElementById('authorSayBox');
            const authorSayContent = document.getElementById('authorSayContent');
            if (item.authorSay) {
                authorSayContent.innerText = item.authorSay;
                authorSayBox.style.display = 'block';
            } else {
                authorSayBox.style.display = 'none';
            }

            // éšè—è¯„è®ºåŒºå’Œæ“ä½œæŒ‰é’®ï¼Œé¿å…æ··æ·†
            document.getElementById('commentList').innerHTML = '<div style="text-align:center; color:#999;">å†å²ç‰ˆæœ¬ä¸æ”¯æŒè¯„è®º</div>';
            document.getElementById('btnNextChapter').disabled = true;
            document.getElementById('btnNextChapter').innerText = "å†å²ç‰ˆæœ¬æ¨¡å¼";
        }

        // åˆ‡æ¢ä½œè€…åè¯æ˜¾ç¤º
        function toggleAuthorSay() {
            const content = document.getElementById('authorSayContent');
            const icon = document.getElementById('authorSayToggleIcon');
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                icon.innerText = 'â–¼';
            } else {
                content.classList.add('show');
                icon.innerText = 'â–²';
            }
        }

        // ç›®å½•å¼¹çª—æ§åˆ¶
        function toggleReaderCatalog() {
            const modal = document.getElementById('readerCatalogModal');
            if (modal.style.display === 'flex') {
                modal.style.display = 'none';
            } else {
                renderReaderCatalog();
                modal.style.display = 'flex';
            }
        }

        function renderReaderCatalog() {
            if (!state.currentBook) return;
            const bookId = state.currentBook.id;
            const listEl = document.getElementById('readerCatalogList');
            const total = state.currentBook.totalChapters;
            const abandonedData = state.abandonedChapters[bookId] || {};
            
            let html = '';
            for (let i = 1; i <= total; i++) {
                const title = state.chapterTitles[bookId]?.[i] || "";
                const isActive = (i === state.currentChapter);
                const hasContent = !!state.chapterCache[bookId]?.[i];
                
                // æ­£å¸¸ç« èŠ‚
                html += `
                    <div class="catalog-item ${isActive ? 'active' : ''}" onclick="startReading(${i}); toggleReaderCatalog();">
                        ç¬¬${toChineseNum(i)}ç«  ${title}
                    </div>
                `;
                
                // åºŸå¼ƒç« èŠ‚
                if (abandonedData[i] && abandonedData[i].length > 0) {
                    abandonedData[i].forEach((item, idx) => {
                        html += `
                            <div class="catalog-item abandoned" onclick="readAbandonedChapter(${i}, ${idx}); toggleReaderCatalog();">
                                ç¬¬${toChineseNum(i)}ç«  (åºŸå¼ƒç‰ˆ${idx+1}) ${item.title || ""}
                            </div>
                        `;
                    });
                }
            }
            listEl.innerHTML = html;
        }

        // åŠ è½½æ›´å¤šè¯„è®º
        async function loadMoreComments() {
            const bookId = state.currentBook.id;
            const chapterNum = state.currentChapter;
            const btn = document.querySelector('.comment-action .btn');
            if(btn) {
                btn.innerText = "åŠ è½½ä¸­...";
                btn.disabled = true;
            }

            let newComments = [];

            // å¦‚æœæœ‰API Keyä¸”æœ‰ç« èŠ‚å†…å®¹ï¼Œå°è¯•ç”¨APIç”Ÿæˆ
            const content = state.chapterCache[bookId]?.[chapterNum];
            if (state.config.apiKey && content) {
                try {
                    // æå–çº¯æ–‡æœ¬å†…å®¹ç”¨äºprompt
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = content;
                    const plainText = tempDiv.innerText.substring(0, 2000); // é™åˆ¶é•¿åº¦

                    const prompt = `è¯·æ ¹æ®ä»¥ä¸‹å°è¯´ç« èŠ‚å†…å®¹ï¼Œç”Ÿæˆ 3 æ¡æ–°çš„è¯»è€…è¯„è®ºã€‚
                    è¦æ±‚ï¼š
                    1. è¯„è®ºå¿…é¡»ç´§æ‰£æœ¬ç« çš„å…·ä½“å‰§æƒ…ã€äººç‰©å¯¹è¯æˆ–ç»†èŠ‚ï¼Œä¸¥ç¦ç”Ÿæˆé€šç”¨çš„â€œå¥½çœ‹â€ã€â€œæ‰“å¡â€ç­‰æ— æ„ä¹‰è¯„è®ºã€‚
                    2. æ¨¡æ‹ŸçœŸå®çš„æ™‹æ±Ÿè¯»è€…è¯­æ°”ï¼Œé£æ ¼è¦å¤šæ ·åŒ–ï¼š
                       - æœ‰çš„è¯»è€…å¯èƒ½åœ¨å°–å«æŠ“ç‹‚ï¼ˆä½¿ç”¨â€œå•Šå•Šå•Šâ€æˆ–emojiï¼‰ã€‚
                       - æœ‰çš„è¯»è€…åœ¨è®¤çœŸåˆ†æå‰§æƒ…ä¼ç¬”ã€‚
                       - æœ‰çš„è¯»è€…åœ¨åæ§½äººç‰©æ“ä½œã€‚
                       - æœ‰çš„è¯»è€…åœ¨ç©æ¢—ã€‚
                    3. æ ¼å¼ä¸ºçº¯æ–‡æœ¬ï¼Œæ¯è¡Œä¸€æ¡ï¼š "ç”¨æˆ·ID: è¯„è®ºå†…å®¹"
                    4. è¯„è®ºå†…å®¹ä¸è¦é‡å¤ï¼Œä¸è¦åŒè´¨åŒ–ã€‚
                    
                    ç« èŠ‚å†…å®¹ç‰‡æ®µï¼š
                    ${plainText}`;

                    const raw = await callGeminiAPI(getFullPrompt(prompt));
                    const lines = raw.split('\n').filter(l => l.trim());
                    newComments = lines.map(line => {
                        const parts = line.split(/[:ï¼š]/);
                        return {
                            user: parts[0].trim() || "çƒ­å¿ƒç½‘å‹",
                            text: parts.slice(1).join(':').trim() || line,
                            likes: Math.floor(Math.random() * 50)
                        };
                    });

                } catch(e) {
                    console.error("è¯„è®ºç”Ÿæˆå¤±è´¥ï¼Œè½¬ä¸ºæ¨¡æ‹Ÿ", e);
                    newComments = generateMockComments(3);
                }
            } else {
                newComments = generateMockComments(3);
            }
            
            if (!state.comments[bookId]) state.comments[bookId] = {};
            if (!state.comments[bookId][chapterNum]) state.comments[bookId][chapterNum] = [];
            
            state.comments[bookId][chapterNum].push(...newComments);
            localStorage.setItem('jj_comments', JSON.stringify(state.comments));
            
            renderComments(bookId, chapterNum);
            
            if(btn) {
                btn.innerText = "æŸ¥çœ‹æ›´å¤šè¯„è®º";
                btn.disabled = false;
            }
        }

        function generateMockComments(count) {
            const users = ["å—‘å­¦å®¶", "æ˜¾å¾®é•œå¥³å­©", "æ°‘æ”¿å±€æ¬æ¥äº†", "åˆ€ç‰‡å¯„é€è€…", "çº¯çˆ±æˆ˜ç¥", "åˆ—æ–‡è™å…‹", "æŒ‰å¤´å°åˆ†é˜Ÿ", "é«˜ä¸¾å¤§æ——", "æ·±æ°´é±¼é›·", "è¥å…»æ¶²çŒæº‰æœº"];
            const part1 = [
                "å•Šå•Šå•Šå•Šå•Šï¼è¿™ä¸€ç« ä¹Ÿå¤ªå¥½çœ‹äº†å§ï¼æˆ‘ç›´æ¥å°–å«é¸¡ï¼",
                "æ•‘å‘½ï¼Œè¿™æ˜¯ä»€ä¹ˆç¥ä»™çˆ±æƒ…ï¼Ÿè™½ç„¶æœ‰ç‚¹è™ï¼Œä½†æ˜¯ç»ç’ƒæ¸£é‡Œæ‰¾ç³–åƒæˆ‘ä¹Ÿæ„¿æ„ï¼",
                "ç»†èŠ‚å¥½è¯„ï¼æ³¨æ„åˆ°äº†å—ï¼Œä¸»è§’åˆšæ‰é‚£ä¸ªåŠ¨ä½œæ˜æ˜¾æ˜¯ä¸‹æ„è¯†çš„ä¿æŠ¤ï¼Œè¿™è¿˜ä¸æ˜¯çˆ±ï¼Ÿ",
                "åˆ†æä¸€ä¸‹å‰§æƒ…ï¼šä¼ç¬”å›æ”¶äº†ï¼ä¹‹å‰ç¬¬ä¸‰ç« æåˆ°çš„é‚£ä¸ªç‰ä½©æœç„¶æ˜¯å…³é”®é“å…·ã€‚",
                "å‘œå‘œå‘œï¼Œæˆ‘çš„çœ¼æ³ªä¸å€¼é’±ã€‚çœ‹åˆ°è¿™é‡ŒçœŸçš„ç ´é˜²äº†ï¼Œä¸ºä»€ä¹ˆç›¸çˆ±çš„äººè¦äº’ç›¸æŠ˜ç£¨ï¼Ÿ",
                "è¿™å¯¹CPæˆ‘å—‘çˆ†ï¼è¿™ç§æ‹‰æ‰¯æ„ŸçœŸçš„ç»äº†ï¼Œä½œè€…å¤§å¤§å¤ªä¼šå†™äº†ã€‚",
                "è™½ç„¶ä½†æ˜¯ï¼Œåæ´¾ä¹Ÿæœ‰ç‚¹è¿·äººæ˜¯æ€ä¹ˆå›äº‹ï¼Ÿæ„Ÿè§‰åæ´¾èƒŒåä¹Ÿæœ‰æ•…äº‹å•Šã€‚",
                "è¿™ä¸€ç« çš„ä¿¡æ¯é‡å¥½å¤§ï¼æ„Ÿè§‰ä¹‹å‰çš„æ¨æµ‹éƒ½è¦æ¨ç¿»äº†ã€‚",
                "å¤ªç”œäº†å¤ªç”œäº†ï¼è¿™ç§åŒå‘å¥”èµ´çš„å‰§æƒ…æˆ‘æœ€çˆ±äº†ã€‚",
                "å¤§å¤§ä½ çš„æ‰‹æ˜¯å€Ÿæ¥çš„å—ï¼Ÿæ€ä¹ˆèƒ½å†™å‡ºè¿™ä¹ˆæœ‰ç”»é¢æ„Ÿçš„æ–‡å­—ï¼"
            ];
            const part2 = [
                "ä¸»è§’ä¹‹é—´çš„å¼ åŠ›æ‹‰æ»¡äº†ï¼Œç‰¹åˆ«æ˜¯é‚£ä¸ªçœ¼ç¥ï¼Œæˆ‘æ­»äº†ï¼è¿™éƒ½ä¸ç»“å©šå¾ˆéš¾æ”¶åœºå•Šï¼",
                "å¤§å¤§å¿«æ›´ï¼Œç”Ÿäº§é˜Ÿçš„é©´éƒ½ä¸æ•¢è¿™ä¹ˆæ­‡ï¼è¥å…»æ¶²éƒ½ç»™ä½ ï¼Œå¿«æŠŠä¸‹ä¸€ç« äº¤å‡ºæ¥ï¼",
                "è¿™ç§éšå¿çš„çˆ±æ„æ¯”ç›´æ¥è¯´å‡ºæ¥æ›´åŠ¨äººï¼Œå“ï¼Œç»†å“ï¼æˆ‘å·²ç»è„‘è¡¥äº†ä¸€ä¸‡å­—ç•ªå¤–äº†ã€‚",
                "æ„Ÿè§‰ä¸‹ä¸€ç« è¦æå¤§äº‹ï¼ŒæœŸå¾…æ‰“è„¸æƒ…èŠ‚ï¼å¸Œæœ›ä¸»è§’èƒ½æ”¯æ£±èµ·æ¥ï¼Œç»™åæ´¾ä¸€ç‚¹é¢œè‰²çœ‹çœ‹ã€‚",
                "å¸Œæœ›åé¢èƒ½ç”œä¸€ç‚¹ï¼Œå­©å­è¦é¥¿æ­»äº†ã€‚ä¿¡å¥³æ„¿ä¸€ç”Ÿè¤ç´ æ­é…æ¢ä»–ä»¬ä¸€ä¸ªHEã€‚",
                "ä¸è¿‡è¿˜æ˜¯ç«™å®˜é…ï¼Œé”æ­»ï¼é’¥åŒ™æˆ‘åäº†ï¼è°ä¹Ÿåˆ«æƒ³æ‹†æ•£ä»–ä»¬ï¼",
                "ä¸»è§’çš„èº«ä»½è‚¯å®šä¸ç®€å•ï¼ŒæœŸå¾…æ‰é©¬çš„é‚£ä¸€åˆ»ï¼åˆ°æ—¶å€™å…¨åœºéœ‡æƒŠï¼Œæƒ³æƒ³å°±çˆ½ã€‚",
                "å§¨æ¯ç¬‘å°±æ²¡æœ‰åœä¸‹æ¥è¿‡ï¼Œä»Šæ™šåšæ¢¦ç´ ææœ‰äº†ã€‚è¿™å°±æ˜¯æˆå¹´äººè¯¥çœ‹çš„çˆ±æƒ…å—ï¼Ÿ",
                "æ„Ÿè§‰åƒåœ¨çœ‹ç”µå½±ä¸€æ ·ï¼Œç”»é¢æ„Ÿå¤ªå¼ºäº†ï¼å»ºè®®åŸåœ°æ‹æˆç”µè§†å‰§ï¼Œæˆ‘ä¸€å®šå……ä¼šå‘˜çœ‹ã€‚",
                "ä½œè€…å¤§å¤§æ³¨æ„èº«ä½“ï¼Œå¤šå–çƒ­æ°´ï¼Œä½†æ˜¯ä¸è¦åœæ›´å•Šï¼æˆ‘çš„å¿«ä¹æºæ³‰å°±é ä½ äº†ã€‚"
            ];
            const part3 = [
                "çœŸçš„ç»ç»å­ï¼Œè¿™ç§è®¾å®šæˆ‘å¥½çˆ±ã€‚æœ‰æ²¡æœ‰ç±»ä¼¼çš„ä»£é¤æ¨èï¼Ÿä¸å¤Ÿçœ‹å•Šï¼",
                "è¿™å°±æ˜¯æˆ‘æ¢¦å¯ä»¥æ±‚çš„å‰§æƒ…ï¼Œå¤§å¤§ä½ æ˜¯æˆ‘çš„ç¥ï¼",
                "çœ‹åˆ°æœ€åä¸€å¥æˆ‘ç›´æ¥èµ·é¸¡çš®ç–™ç˜©ï¼Œå¤ªå¸¦æ„Ÿäº†ï¼",
                "å‰é¢çš„ä¼ç¬”åŸ‹å¾—å¤ªæ·±äº†ï¼Œç°åœ¨æ‰ååº”è¿‡æ¥ï¼Œå¤§å¤§ä¸‹äº†ä¸€ç›˜å¤§æ£‹å•Šã€‚",
                "è™½ç„¶è¿‡ç¨‹æ›²æŠ˜ï¼Œä½†æ˜¯åªè¦ç»“å±€æ˜¯å¥½çš„æˆ‘å°±èƒ½æ¥å—ã€‚è¯·åŠ¡å¿…ç»™ä»–ä»¬ä¸€ä¸ªå®Œç¾çš„ç»“å±€ï¼",
                "è¿™ç§å®¿å‘½æ„ŸçœŸçš„å¤ªæˆ³æˆ‘äº†ï¼Œæ„Ÿè§‰ä»–ä»¬æ³¨å®šè¦åœ¨ä¸€èµ·ã€‚",
                "åæ´¾çš„æ™ºå•†ä¹Ÿåœ¨çº¿ï¼Œè¿™ç§åŠ¿å‡åŠ›æ•Œçš„è¾ƒé‡æ‰å¥½çœ‹å˜›ã€‚",
                "æ¯å¤©åˆ·åéçœ‹æœ‰æ²¡æœ‰æ›´æ–°ï¼Œæˆ‘å¥½åƒä¸­æ¯’äº†ã€‚",
                "ä¸ä»…å‰§æƒ…å¥½çœ‹ï¼Œæ–‡ç¬”ä¹Ÿè¶…å¥½ï¼Œæ¯ä¸€å¥éƒ½å†™åœ¨æˆ‘çš„å¿ƒå·´ä¸Šã€‚",
                "ä¸ºäº†çœ‹è¿™ç« æˆ‘é¥­éƒ½æ²¡åƒï¼Œå€¼äº†ï¼"
            ];
            
            let res = [];
            for(let i=0; i<count; i++) {
                // éšæœºç»„åˆ 3 å¥è¯ï¼Œç¡®ä¿é•¿åº¦åœ¨ 3-6 å¥å·¦å³ï¼ˆæ¯éƒ¨åˆ†å¯èƒ½åŒ…å«1-2å¥ï¼‰
                let text = part1[Math.floor(Math.random() * part1.length)] + 
                           part2[Math.floor(Math.random() * part2.length)] + 
                           part3[Math.floor(Math.random() * part3.length)];
                
                res.push({
                    user: users[Math.floor(Math.random() * users.length)] + "_" + Math.floor(Math.random()*1000),
                    text: text,
                    likes: Math.floor(Math.random() * 500)
                });
            }
            return res;
        }

        function renderComments(bookId, chapterNum) {
            const list = state.comments[bookId]?.[chapterNum] || [];
            const container = document.getElementById('commentList');
            
            container.innerHTML = list.map(c => `
                <div class="comment-item">
                    <div class="comment-user">
                        <span>${c.user}</span>
                        <span>ğŸ‘ ${c.likes}</span>
                    </div>
                    <div class="comment-text">${c.text}</div>
                </div>
            `).join('');
        }

        function saveChapterSummary() {
            if(!state.currentBook) return;
            const val = document.getElementById('chapterSummary').value;
            const bookId = state.currentBook.id;
            if(!state.chapterSummaries[bookId]) state.chapterSummaries[bookId] = {};
            state.chapterSummaries[bookId][state.currentChapter] = val;
            localStorage.setItem('jj_chapter_summaries', JSON.stringify(state.chapterSummaries));
        }

        async function autoGenerateSummary() {
            const content = document.getElementById('readerBody').innerText;
            if(!content || content.length < 50) return alert("ç« èŠ‚å†…å®¹å¤ªå°‘ï¼Œæ— æ³•æ€»ç»“");
            
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "æ€»ç»“ä¸­...";
            btn.disabled = true;

            const prompt = `è¯·æ€»ç»“ä»¥ä¸‹å°è¯´ç« èŠ‚å†…å®¹ï¼Œä½œä¸ºå‰æƒ…æè¦ã€‚
            
            æ€»ç»“åº”å½“éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š
            - æŒ‰é€»è¾‘é¡ºåºç»„ç»‡ä¿¡æ¯ï¼Œå¹¶åŒ…å«å…·ä½“çš„å‰åæ—¶é—´ï¼Œå¯åˆ†è¾¨ä¸åŒæ—¶é—´å‘ç”Ÿçš„äº‹æƒ…
            - ä¿ç•™å…³é”®äº‹ä»¶å’Œé‡è¦ç»†èŠ‚ï¼Œé¿å…å†—ä½™æè¿°
            - ç›´æ¥é™ˆè¿°äº‹å®ï¼Œé¿å…è¯„ä»·
            - ä½¿ç”¨ç®€æ´æ¸…æ™°çš„è¯­è¨€ï¼Œé¿å…ä¿®é¥°
            - çªå‡ºäº‹ä»¶å‘å±•è„‰ç»œå’Œå…³é”®è½¬æŠ˜ç‚¹
            - ä¿ç•™é‡è¦çš„çº¦å®šã€ç‰©å“ã€äº‹ä»¶ä»¥åŠæƒ…æ„Ÿå‘å±•
            - ä¸å›é¿ä»»ä½•æ•æ„Ÿå†…å®¹ï¼Œä¿è¯è®°å½•å®Œå…¨è¿˜åŸå‰æ–‡
            - å¯ä»¥ç²¾ç®€åˆå¹¶è¾ƒä¸ºä¹…è¿œä¹‹å‰çš„äº‹ä»¶
            - æ— éœ€åŠ ç²—æ ‡æ³¨
            - ä»¥æµæ°´è´¦å½¢å¼è®°å½•

            æ ¼å¼å¦‚ä¸‹ï¼š
            - æ—¶é—´:
              - å…³é”®äº‹ä»¶ï¼ˆéœ€è¦ä»¥æµæ°´å¸å½¢å¼ç»¼è¿°äº‹ä»¶ç»è¿‡å’Œæ¶‰åŠäººç‰©ï¼‰:
              - é‡è¦ç»†èŠ‚:
              - å…³é”®å¯¹è¯å’Œå†…å¿ƒæˆ:(æ ‡æ˜è§’è‰²)
              - å…³é”®è¡Œä¸ºï¼š(æ ‡æ˜è§’è‰²)
              - å…³é”®è§’è‰²å’Œæ›²ä»¥æ¾œï¼ˆè¯·æ›¿æ¢ä¸ºä¸»è§’åï¼‰ä¹‹é—´çš„æƒ…æ„Ÿå˜åŒ–ï¼ˆé€‰å¡«ï¼‰:
              - ç®€è¦çš„äº‹ä»¶åç»­ï¼Œäº‹ä»¶ç»“æŸåçš„å°äº’åŠ¨ï¼ˆé€‰å¡«ï¼‰:
            
            ç« èŠ‚å†…å®¹ï¼š
            ${content.substring(0, 5000)}`;

            let summary = "";
            
            if (state.config.apiKey) {
                try {
                    summary = await callGeminiAPI(getFullPrompt(prompt));
                } catch(e) {
                    alert("æ‘˜è¦ç”Ÿæˆå¤±è´¥: " + e.message);
                    summary = "ï¼ˆAPIè°ƒç”¨å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¡«å†™æ‘˜è¦ï¼‰";
                }
            } else {
                // æ¨¡æ‹ŸAPIè°ƒç”¨
                await new Promise(r => setTimeout(r, 1500));
                summary = `- æ—¶é—´: ç« èŠ‚å‘ç”Ÿçš„æ—¶é—´ç‚¹\n  - å…³é”®äº‹ä»¶: ä¸»è§’ç»å†äº†... (åŸºäºå†…å®¹è‡ªåŠ¨ç”Ÿæˆ)\n  - é‡è¦ç»†èŠ‚: ...\n  - å…³é”®å¯¹è¯: ...\n  - æƒ…æ„Ÿå˜åŒ–: ...`;
            }

            document.getElementById('chapterSummary').value = summary;
            saveChapterSummary();
            
            btn.innerText = originalText;
            btn.disabled = false;
        }

        // æ›´æ–°é˜…è¯»å™¨æŒ‰é’®çŠ¶æ€
        function updateNavButtons(loading = false) {
            const btnPrev = document.getElementById('btnPrevChapter');
            const btnNext = document.getElementById('btnNextChapter');
            
            if (loading) {
                btnPrev.disabled = true;
                btnNext.disabled = true;
                return;
            }

            btnPrev.disabled = (state.currentChapter <= 1);
            
            if (state.currentChapter >= state.currentBook.totalChapters) {
                btnNext.innerText = "å·²æ˜¯æœ€åä¸€ç« ";
                btnNext.disabled = true;
                btnNext.classList.remove('btn-jj');
                btnNext.classList.add('btn-outline');
            } else {
                btnNext.innerText = "ä¸‹ä¸€ç«  (AIåˆ›ä½œ)";
                btnNext.disabled = false;
                btnNext.classList.add('btn-jj');
                btnNext.classList.remove('btn-outline');
            }
        }

        // --- å…¶ä»–æœªä¿®æ”¹çš„é€»è¾‘ä¿æŒä¸å˜ ---

        function addToShelf() {
            if(!state.currentBook) return;
            
            // 1. è¯»å–å·²æœ‰ä¹¦å•ï¼šå…ˆè·å–localStorageä¸­å·²ä¿å­˜çš„ä¹¦æ¶æ•°æ®
            let currentShelf = [];
            try {
                currentShelf = JSON.parse(localStorage.getItem('jj_bookshelf')) || [];
            } catch (e) {
                console.error("è¯»å–ä¹¦æ¶å¤±è´¥", e);
                currentShelf = [];
            }

            // 2. æ·»åŠ æ–°ä¹¦ï¼šå°†æ–°ä¹¦åŠ å…¥åˆ°è¿™ä¸ªä¹¦å•æ•°ç»„ä¸­
            // ä½¿ç”¨ title æˆ– id åˆ¤é‡
            const isDuplicate = currentShelf.some(b => b.id === state.currentBook.id || b.title === state.currentBook.title);
            
            if (!isDuplicate) {
                currentShelf.unshift(state.currentBook);
                
                // 3. ä¿å­˜å®Œæ•´ä¹¦å•ï¼šæŠŠæ•´ä¸ªæ•°ç»„ä¿å­˜å›localStorage
                localStorage.setItem('jj_bookshelf', JSON.stringify(currentShelf));
                
                // åŒæ­¥æ›´æ–°å†…å­˜ä¸­çš„çŠ¶æ€ï¼Œä»¥å…é¡µé¢ä¸åˆ·æ–°æ—¶æ˜¾ç¤ºæ—§æ•°æ®
                state.bookshelf = currentShelf;
                
                alert("å·²æ”¶è—åˆ°ä¹¦æ¶ï¼");
            } else {
                alert("ä¹¦æ¶é‡Œå·²ç»æœ‰è¿™æœ¬ä¹¦å•¦ï¼");
            }
        }

        // ä¿®æ”¹ï¼šä¹¦æ¶æ¸²æŸ“é€»è¾‘ï¼Œå±•ç¤ºä¹¦åå’Œç®€ä»‹
        function toggleBatchMode() {
            state.isBatchMode = !state.isBatchMode;
            state.selectedBooks = new Set();
            document.getElementById('batchActions').style.display = state.isBatchMode ? 'block' : 'none';
            document.getElementById('btnBatchMode').classList.toggle('btn-jj');
            document.getElementById('btnBatchMode').classList.toggle('btn-outline');
            document.getElementById('btnBatchMode').innerText = state.isBatchMode ? 'é€€å‡ºæ‰¹é‡' : 'æ‰¹é‡ç®¡ç†';
            renderShelf();
        }

        function toggleBookSelection(bookId) {
            if (state.selectedBooks.has(bookId)) {
                state.selectedBooks.delete(bookId);
            } else {
                state.selectedBooks.add(bookId);
            }
            document.getElementById('selectedCount').innerText = state.selectedBooks.size;
            renderShelf();
        }

        function deleteSelectedBooks() {
            if (state.selectedBooks.size === 0) return alert("è¯·å…ˆé€‰æ‹©ä¹¦ç±");
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${state.selectedBooks.size} æœ¬ä¹¦å—ï¼Ÿ`)) return;
            
            state.bookshelf = state.bookshelf.filter(b => !state.selectedBooks.has(b.id));
            localStorage.setItem('jj_bookshelf', JSON.stringify(state.bookshelf));
            state.selectedBooks.clear();
            document.getElementById('selectedCount').innerText = 0;
            renderShelf();
        }

        function exportSelectedData(format) {
            if (state.selectedBooks.size === 0) return alert("è¯·å…ˆé€‰æ‹©ä¹¦ç±");
            
            const selected = state.bookshelf.filter(b => state.selectedBooks.has(b.id));
            
            if (format === 'json') {
                const dataStr = JSON.stringify(selected, null, 2);
                downloadFile(dataStr, `jj_books_export_${Date.now()}.json`, 'application/json');
            } else if (format === 'txt') {
                let txtContent = "";
                selected.forEach(b => {
                    txtContent += `=== ${b.title} ===\n`;
                    txtContent += `ä½œè€…ï¼š${b.author}\nç±»å‹ï¼š${b.genre}\nç®€ä»‹ï¼š${b.intro}\n\n`;
                });
                downloadFile(txtContent, `jj_books_export_${Date.now()}.txt`, 'text/plain');
            }
        }

        function downloadFile(content, fileName, mimeType) {
            const blob = new Blob([content], {type: mimeType});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = fileName;
            a.click();
        }

        // ä¿®æ”¹ï¼šä¹¦æ¶æ¸²æŸ“é€»è¾‘ï¼Œå±•ç¤ºä¹¦åå’Œç®€ä»‹
        function renderShelf() {
            // æ¯æ¬¡æ¸²æŸ“å‰é‡æ–°è¯»å–æœ¬åœ°å­˜å‚¨ï¼Œç¡®ä¿æ•°æ®åŒæ­¥
            try {
                state.bookshelf = JSON.parse(localStorage.getItem('jj_bookshelf')) || [];
            } catch (e) {
                console.error("åŒæ­¥ä¹¦æ¶å¤±è´¥", e);
            }

            const grid = document.getElementById('shelfGrid');
            if (!grid) return;

            const searchInput = document.getElementById('shelfSearch');
            const keyword = searchInput ? searchInput.value.toLowerCase() : "";
            
            // å¢åŠ æ•°æ®é²æ£’æ€§æ£€æŸ¥ï¼Œé˜²æ­¢å› è„æ•°æ®å¯¼è‡´æ¸²æŸ“å´©æºƒ
            const filtered = state.bookshelf.filter(b => {
                if (!b || typeof b !== 'object') return false;
                const title = b.title ? b.title.toLowerCase() : "";
                const hasTitle = title.includes(keyword);
                const hasTag = Array.isArray(b.tags) && b.tags.some(t => typeof t === 'string' && t.toLowerCase().includes(keyword));
                return hasTitle || hasTag;
            });
            
            // ä¿®æ”¹åçš„æ¸²æŸ“æ¨¡æ¿ï¼Œæ”¯æŒæ˜¾ç¤ºç®€ä»‹
            grid.innerHTML = filtered.map((book) => {
                const isSelected = state.selectedBooks.has(book.id);
                const clickAction = state.isBatchMode 
                    ? `toggleBookSelection(${book.id})` 
                    : `showBookDetail(${JSON.stringify(book).replace(/'/g, "&#39;")})`;
                
                return `
                <div class="shelf-book" onclick='${clickAction}' style="${isSelected ? 'border:2px solid var(--jj-green); background:#f0f9f4;' : ''}">
                    ${state.isBatchMode ? `<div style="position:absolute; top:5px; right:5px; color:var(--jj-green); font-weight:bold;">${isSelected ? 'âœ“' : 'â—‹'}</div>` : ''}
                    <div class="book-cover-sm" style="background:${book.coverColor || '#eee'}">${book.title.substring(0,6)}</div>
                    <div class="shelf-book-info-col">
                        <div class="shelf-book-title">${book.title}</div>
                        <div class="shelf-book-intro">${book.intro || "æš‚æ— ç®€ä»‹..."}</div>
                    </div>
                </div>
            `}).join('');
            
            if(filtered.length === 0) grid.innerHTML = '<div style="color:#999; text-align:center; padding:20px;">ä¹¦æ¶ç©ºç©ºå¦‚ä¹Ÿ</div>';
        }

        function exportData() {
            const dataStr = JSON.stringify(state.bookshelf, null, 2);
            downloadFile(dataStr, "jj_bookshelf_backup.json", "application/json");
        }

        // æ–°å¢ï¼šå¯¼å‡ºå…¨å±€æ•°æ®
        function exportGlobalData() {
            const backup = {
                timestamp: Date.now(),
                version: "2.3",
                data: {}
            };
            
            // éå†æ‰€æœ‰ jj_ å¼€å¤´çš„ localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('jj_')) {
                    try {
                        backup.data[key] = JSON.parse(localStorage.getItem(key));
                    } catch(e) {
                        backup.data[key] = localStorage.getItem(key);
                    }
                }
            }
            
            const dataStr = JSON.stringify(backup, null, 2);
            downloadFile(dataStr, `jj_global_backup_${new Date().toISOString().slice(0,10)}.json`, 'application/json');
        }

        // æ–°å¢ï¼šå¯¼å…¥å…¨å±€æ•°æ®
        function importGlobalData(input) {
            const file = input.files[0];
            if(!file) return;
            
            if(!confirm("è­¦å‘Šï¼šå¯¼å…¥å…¨å±€å¤‡ä»½å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼ˆä¹¦æ¶ã€ä¸–ç•Œè§‚ã€è®¾ç½®ã€é˜…è¯»å†å²ç­‰ï¼‰ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ")) {
                input.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    if (!backup.data) throw new Error("æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶æ ¼å¼");
                    
                    // æ¢å¤æ•°æ®
                    for (const key in backup.data) {
                        if (key.startsWith('jj_')) {
                            const val = backup.data[key];
                            localStorage.setItem(key, typeof val === 'object' ? JSON.stringify(val) : val);
                        }
                    }
                    
                    alert("å…¨å±€æ•°æ®æ¢å¤æˆåŠŸï¼é¡µé¢å°†åˆ·æ–°ä»¥åº”ç”¨æ›´æ”¹ã€‚");
                    location.reload();
                } catch(err) {
                    console.error(err);
                    alert("å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶è§£æé”™è¯¯æˆ–æ ¼å¼ä¸æ­£ç¡®");
                }
                input.value = '';
            };
            reader.readAsText(file);
        }

        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const fileName = file.name.toLowerCase();
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const content = e.target.result;
                let newBooks = [];
                
                try {
                    if (fileName.endsWith('.json')) {
                        const data = JSON.parse(content);
                        if(Array.isArray(data)) newBooks = data;
                        else if(typeof data === 'object') newBooks = [data];
                    } else if (fileName.endsWith('.txt')) {
                        // å°è¯•è§£æç‰¹å®šæ ¼å¼ (=== Title ===)
                        if (content.includes('=== ')) {
                            const parts = content.split('=== ').filter(p => p.trim());
                            parts.forEach(part => {
                                const lines = part.split('\n');
                                const titleLine = lines[0].trim();
                                const title = titleLine.replace(' ===', '');
                                
                                let author = "æœªçŸ¥";
                                let genre = "æœªçŸ¥";
                                let intro = "";
                                
                                lines.slice(1).forEach(line => {
                                    if(line.startsWith('ä½œè€…ï¼š')) author = line.replace('ä½œè€…ï¼š', '').trim();
                                    else if(line.startsWith('ç±»å‹ï¼š')) genre = line.replace('ç±»å‹ï¼š', '').trim();
                                    else if(line.startsWith('ç®€ä»‹ï¼š')) intro = line.replace('ç®€ä»‹ï¼š', '').trim();
                                    else if(line.trim()) intro += '\n' + line.trim();
                                });
                                
                                if(title) {
                                    newBooks.push({
                                        id: Date.now() + Math.random(),
                                        title, author, genre, intro,
                                        tags: [],
                                        words: 0,
                                        score: "0.0",
                                        status: "æœªçŸ¥",
                                        totalChapters: 0,
                                        coverColor: '#eee'
                                    });
                                }
                            });
                        } else {
                            // æ™®é€šTXTæ–‡ä»¶å¯¼å…¥ï¼šå°†æ–‡ä»¶åä½œä¸ºä¹¦åï¼Œå†…å®¹ä½œä¸ºç®€ä»‹
                            const title = file.name.replace('.txt', '');
                            newBooks.push({
                                id: Date.now(),
                                title: title,
                                author: "æœ¬åœ°å¯¼å…¥",
                                genre: "æ–‡æœ¬æ–‡ä»¶",
                                intro: content.substring(0, 500) + (content.length > 500 ? "..." : ""),
                                tags: ["å¯¼å…¥"],
                                words: content.length,
                                score: "0.0",
                                status: "æœ¬åœ°",
                                totalChapters: 1,
                                coverColor: '#eef7f2'
                            });
                        }
                    }
                    
                    if(newBooks.length > 0) {
                        let addedCount = 0;
                        newBooks.forEach(nb => {
                            // æ ¹æ®ä¹¦åå»é‡
                            if(!state.bookshelf.some(b => b.title === nb.title)) {
                                state.bookshelf.unshift(nb);
                                addedCount++;
                            }
                        });
                        
                        localStorage.setItem('jj_bookshelf', JSON.stringify(state.bookshelf));
                        renderShelf();
                        alert(`æˆåŠŸå¯¼å…¥ ${addedCount} æœ¬ä¹¦ï¼(å·²è¿‡æ»¤é‡å¤ä¹¦ç±)`);
                    } else {
                        alert("æœªæ‰¾åˆ°æœ‰æ•ˆçš„ä¹¦ç±æ•°æ®æˆ–æ ¼å¼ä¸æ”¯æŒ");
                    }
                } catch(err) {
                    console.error(err);
                    alert("å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶è§£æé”™è¯¯");
                }
                // é‡ç½®inputï¼Œå…è®¸é‡å¤å¯¼å…¥åŒåæ–‡ä»¶
                input.value = '';
            };
            
            reader.readAsText(file);
        }

        // --- ä¸–ç•Œè§‚ç®¡ç†æ–°é€»è¾‘ ---

        function switchWorldTab(tabName) {
            // åˆ‡æ¢ Tab æ ·å¼
            const tabs = document.querySelectorAll('.world-tab-item');
            tabs.forEach(t => {
                if(t.getAttribute('data-tab') === tabName) {
                    t.classList.add('active');
                } else {
                    t.classList.remove('active');
                }
            });

            // åˆ‡æ¢å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('.world-tab-content').forEach(el => el.style.display = 'none');
            document.getElementById(`tab_content_${tabName}`).style.display = 'block';
            
            // é‡æ–°æ¸²æŸ“å¯¹åº”åˆ—è¡¨ï¼ˆç¡®ä¿æ•°æ®æœ€æ–°ï¼‰
            renderSection(tabName);
        }

        function renderWorldPage() {
            // é»˜è®¤æ˜¾ç¤ºè§’è‰²é¡µï¼Œæˆ–è€…ä¿æŒå½“å‰çŠ¶æ€
            // è¿™é‡Œç®€å•å¤„ç†ï¼Œæ¸²æŸ“æ‰€æœ‰åˆ—è¡¨ï¼Œä½†æ˜¾ç¤ºç”± Tab æ§åˆ¶
            renderSection('character');
            renderSection('worldbook');
            renderSection('tag');
        }

        function renderSection(type) {
            const container = document.getElementById(`list_${type}`);
            const items = state.worldSettings.filter(item => item.type === type);
            
            if(items.length === 0) {
                container.innerHTML = '<div style="color:#999; text-align:center; padding:10px; font-size:12px; width:100%;">æš‚æ— å†…å®¹</div>';
                return;
            }

            // é’ˆå¯¹æ ‡ç­¾ç±»å‹çš„ç‰¹æ®Šæ¸²æŸ“
            if (type === 'tag') {
                container.innerHTML = items.map(item => `
                    <div class="world-tag-item">
                        <span>${item.name}</span>
                        <span class="world-tag-close" onclick="deleteWorldItem(${item.id})">Ã—</span>
                    </div>
                `).join('');
                return;
            }

            // å…¶ä»–ç±»å‹ï¼ˆè§’è‰²ã€ä¸–ç•Œä¹¦ï¼‰çš„æ¸²æŸ“
            container.innerHTML = items.map(item => {
                if(state.editingId === item.id) {
                    // ç¼–è¾‘æ¨¡å¼
                    return `
                        <div class="edit-mode-box">
                            <div class="input-group" style="margin-bottom:5px;">
                                <input type="text" id="edit_name_${item.id}" value="${item.name}" class="large-input">
                            </div>
                            <div class="input-group" style="margin-bottom:5px;">
                                <textarea id="edit_desc_${item.id}" rows="5" class="large-textarea">${item.desc || ''}</textarea>
                            </div>
                            <div style="text-align:right; margin-top:5px;">
                                <button class="btn btn-sm btn-outline" onclick="cancelEdit()">å–æ¶ˆ</button>
                                <button class="btn btn-sm btn-jj" onclick="saveWorldItem(${item.id})">ä¿å­˜</button>
                            </div>
                        </div>
                    `;
                } else {
                    // å±•ç¤ºæ¨¡å¼
                    return `
                        <div class="setting-item">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                <strong style="color:#333;">${item.name}</strong>
                                <div class="setting-item-actions">
                                    <button class="btn btn-sm btn-outline" onclick="editWorldItem(${item.id})">ä¿®æ”¹</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteWorldItem(${item.id})">åˆ é™¤</button>
                                </div>
                            </div>
                            ${item.desc ? `<div class="setting-content">${item.desc}</div>` : ''}
                        </div>
                    `;
                }
            }).join('');
        }

        function addWorldItem(type) {
            const nameInput = document.getElementById(`new_${type}_name`);
            const descInput = document.getElementById(`new_${type}_desc`); // tagç±»å‹å¯èƒ½æ²¡æœ‰è¿™ä¸ª
            
            const name = nameInput.value.trim();
            const desc = descInput ? descInput.value.trim() : "";

            if(!name) return alert("åç§°ä¸èƒ½ä¸ºç©º");

            state.worldSettings.push({
                id: Date.now(),
                type: type,
                name: name,
                desc: desc
            });
            
            saveWorldData();
            
            // æ¸…ç©ºè¾“å…¥
            nameInput.value = '';
            if(descInput) descInput.value = '';
            
            renderSection(type);
        }

        function deleteWorldItem(id) {
            if(!confirm("ç¡®å®šåˆ é™¤å—ï¼Ÿ")) return;
            state.worldSettings = state.worldSettings.filter(item => item.id !== id);
            saveWorldData();
            renderWorldPage();
        }

        function editWorldItem(id) {
            state.editingId = id;
            renderWorldPage();
        }

        function cancelEdit() {
            state.editingId = null;
            renderWorldPage();
        }

        function saveWorldItem(id) {
            const name = document.getElementById(`edit_name_${id}`).value.trim();
            const descEl = document.getElementById(`edit_desc_${id}`);
            const desc = descEl ? descEl.value.trim() : "";

            if(!name) return alert("åç§°ä¸èƒ½ä¸ºç©º");

            const item = state.worldSettings.find(i => i.id === id);
            if(item) {
                item.name = name;
                item.desc = desc;
                state.editingId = null;
                saveWorldData();
                renderWorldPage();
            }
        }

        function saveWorldData() {
            localStorage.setItem('jj_world', JSON.stringify(state.worldSettings));
        }

        // --- å¯¼å…¥å¯¼å‡ºåŠŸèƒ½ ---

        function triggerImport(type) {
            document.getElementById(`import_${type}`).click();
        }

        function handleImport(input, type) {
            const file = input.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(!Array.isArray(data)) throw new Error("æ ¼å¼é”™è¯¯ï¼šå¿…é¡»æ˜¯æ•°ç»„");
                    
                    let count = 0;
                    data.forEach(item => {
                        // ç®€å•çš„å»é‡æ£€æŸ¥ (åŒåä¸”åŒç±»å‹)
                        if(!state.worldSettings.some(exist => exist.type === type && exist.name === item.name)) {
                            state.worldSettings.push({
                                id: Date.now() + Math.random(),
                                type: type,
                                name: item.name,
                                desc: item.desc || ""
                            });
                            count++;
                        }
                    });

                    // è‡ªåŠ¨å…³è”æ ‡ç­¾é€»è¾‘ï¼šå¯¼å…¥è§’è‰²/ä¸–ç•Œä¹¦æ—¶ï¼Œè‡ªåŠ¨æ·»åŠ å¯¹åº”æ ‡ç­¾
                    if (count > 0 && (type === 'character' || type === 'worldbook')) {
                        const autoTagName = type === 'character' ? 'è§’è‰²' : 'ä¸–ç•Œè®¾å®š';
                        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥æ ‡ç­¾
                        if (!state.worldSettings.some(item => item.type === 'tag' && item.name === autoTagName)) {
                            state.worldSettings.push({
                                id: Date.now() + Math.random(),
                                type: 'tag',
                                name: autoTagName,
                                desc: 'ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆçš„æ ‡ç­¾'
                            });
                            // å¦‚æœå½“å‰åœ¨æ ‡ç­¾é¡µï¼Œéœ€è¦åˆ·æ–°æ ‡ç­¾é¡µ
                            if (document.getElementById('tab_content_tag').style.display === 'block') {
                                renderSection('tag');
                            }
                        }
                    }
                    
                    saveWorldData();
                    renderSection(type);
                    alert(`æˆåŠŸå¯¼å…¥ ${count} æ¡æ•°æ®`);
                } catch(err) {
                    alert("å¯¼å…¥å¤±è´¥ï¼š" + err.message);
                }
                input.value = ''; // é‡ç½®
            };
            reader.readAsText(file);
        }

        function exportWorldData(type) {
            const items = state.worldSettings.filter(item => item.type === type).map(item => ({
                name: item.name,
                desc: item.desc
            }));
            
            if(items.length === 0) return alert("æ²¡æœ‰æ•°æ®å¯å¯¼å‡º");
            
            const json = JSON.stringify(items, null, 2);
            downloadFile(json, `jj_${type}_export.json`, 'application/json');
        }

        function clearWorldData(type) {
            if(!confirm(`ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ã€${type === 'character' ? 'è§’è‰²' : (type === 'worldbook' ? 'ä¸–ç•Œä¹¦' : 'æ ‡ç­¾')}ã€‘æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
            
            state.worldSettings = state.worldSettings.filter(item => item.type !== type);
            saveWorldData();
            renderSection(type);
        }

        // --- é…ç½®ç®¡ç†é€»è¾‘ ---

        function loadSettingsUI() {
            // æ¸²æŸ“é…ç½®åˆ—è¡¨
            renderConfigList();
            
            // åŠ è½½å½“å‰ç”Ÿæ•ˆçš„é…ç½®åˆ°è¡¨å•
            fillConfigForm(state.config);

            // åŠ è½½æ ¸å¿ƒæŒ‡ä»¤UI
            loadCoreSettingsUI();
        }

        // --- æ ¸å¿ƒæŒ‡ä»¤ç®¡ç†é€»è¾‘ ---

        function loadCoreSettingsUI() {
            document.getElementById('coreInstruction').value = state.currentCoreInstruction || "";
            renderCorePresets();
        }

        function renderCorePresets() {
            const select = document.getElementById('corePresetsSelect');
            select.innerHTML = '<option value="">-- é€‰æ‹©é¢„è®¾ --</option>';
            state.corePresets.forEach((p, index) => {
                const opt = document.createElement('option');
                opt.value = index;
                opt.text = p.name;
                select.add(opt);
            });
        }

        function saveCoreInstruction() {
            const val = document.getElementById('coreInstruction').value.trim();
            state.currentCoreInstruction = val;
            localStorage.setItem('jj_current_core_instruction', val);
            alert("æ ¸å¿ƒæŒ‡ä»¤å·²æ›´æ–°ï¼å°†åœ¨ä¸‹æ¬¡ç”Ÿæˆæ—¶ç”Ÿæ•ˆã€‚");
        }

        function clearCoreInstruction() {
            if(confirm("ç¡®å®šæ¸…ç©ºå½“å‰æ ¸å¿ƒæŒ‡ä»¤å—ï¼Ÿ")) {
                document.getElementById('coreInstruction').value = "";
                saveCoreInstruction();
            }
        }

        function saveAsCorePreset() {
            const val = document.getElementById('coreInstruction').value.trim();
            if(!val) return alert("å½“å‰æŒ‡ä»¤ä¸ºç©ºï¼Œæ— æ³•ä¿å­˜");
            
            const name = prompt("è¯·è¾“å…¥é¢„è®¾åç§°ï¼š");
            if(!name) return;

            state.corePresets.push({
                name: name,
                content: val
            });
            localStorage.setItem('jj_core_presets', JSON.stringify(state.corePresets));
            renderCorePresets();
            alert("é¢„è®¾ä¿å­˜æˆåŠŸï¼");
        }

        function loadCorePreset() {
            const idx = document.getElementById('corePresetsSelect').value;
            if(idx === "") return;
            
            const preset = state.corePresets[idx];
            if(preset) {
                document.getElementById('coreInstruction').value = preset.content;
            }
        }

        function deleteCorePreset() {
            const idx = document.getElementById('corePresetsSelect').value;
            if(idx === "") return alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé¢„è®¾");
            
            if(confirm("ç¡®å®šåˆ é™¤è¯¥é¢„è®¾å—ï¼Ÿ")) {
                state.corePresets.splice(idx, 1);
                localStorage.setItem('jj_core_presets', JSON.stringify(state.corePresets));
                renderCorePresets();
                document.getElementById('coreInstruction').value = ""; // å¯é€‰ï¼šæ¸…ç©ºè¾“å…¥æ¡†
            }
        }

        function exportCorePreset() {
            const idx = document.getElementById('corePresetsSelect').value;
            let dataToExport = [];
            
            if(idx !== "") {
                // å¯¼å‡ºå•ä¸ªé€‰ä¸­
                dataToExport = [state.corePresets[idx]];
            } else {
                // å¯¼å‡ºæ‰€æœ‰
                if(state.corePresets.length === 0) return alert("æ²¡æœ‰é¢„è®¾å¯å¯¼å‡º");
                if(!confirm("æœªé€‰æ‹©ç‰¹å®šé¢„è®¾ï¼Œå°†å¯¼å‡ºæ‰€æœ‰é¢„è®¾ï¼Ÿ")) return;
                dataToExport = state.corePresets;
            }

            const json = JSON.stringify(dataToExport, null, 2);
            downloadFile(json, `jj_core_presets_${Date.now()}.json`, 'application/json');
        }

        function importCorePreset(input) {
            const file = input.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(!Array.isArray(data)) throw new Error("æ ¼å¼é”™è¯¯");
                    
                    let count = 0;
                    data.forEach(item => {
                        if(item.name && item.content) {
                            state.corePresets.push({
                                name: item.name,
                                content: item.content
                            });
                            count++;
                        }
                    });
                    
                    localStorage.setItem('jj_core_presets', JSON.stringify(state.corePresets));
                    renderCorePresets();
                    alert(`æˆåŠŸå¯¼å…¥ ${count} ä¸ªé¢„è®¾`);
                } catch(err) {
                    alert("å¯¼å…¥å¤±è´¥ï¼š" + err.message);
                }
                input.value = '';
            };
            reader.readAsText(file);
        }

        function renderConfigList() {
            const select = document.getElementById('savedConfigs');
            select.innerHTML = '<option value="">-- æ–°å»ºé…ç½® --</option>';
            state.configList.forEach((cfg, index) => {
                const opt = document.createElement('option');
                opt.value = index;
                opt.text = cfg.name;
                select.add(opt);
            });
        }

        function fillConfigForm(config) {
            document.getElementById('apiKey').value = config.apiKey || '';
            document.getElementById('apiUrl').value = config.apiUrl || '';
            
            // ç¡®ä¿æ¨¡å‹é€‰é¡¹å­˜åœ¨
            const model = config.model || 'gemini-1.5-flash';
            const select = document.getElementById('modelSelect');
            let exists = false;
            for(let i=0; i<select.options.length; i++) {
                if(select.options[i].value === model) {
                    exists = true;
                    break;
                }
            }
            if(!exists) {
                const opt = document.createElement('option');
                opt.value = model;
                opt.text = model;
                select.add(opt);
            }
            select.value = model;
        }

        function loadSelectedConfig() {
            const index = document.getElementById('savedConfigs').value;
            if (index === "") {
                // æ–°å»ºæ¨¡å¼ï¼Œæ¸…ç©ºè¡¨å•
                document.getElementById('configName').value = "";
                fillConfigForm({ apiKey: '', apiUrl: '', model: 'gemini-1.5-flash' });
            } else {
                const cfg = state.configList[index];
                document.getElementById('configName').value = cfg.name;
                fillConfigForm(cfg);
            }
        }

        function saveConfig() {
            const name = document.getElementById('configName').value.trim();
            if (!name) return alert("è¯·ä¸ºé…ç½®èµ·ä¸ªåå­—");

            const newConfig = {
                name: name,
                apiKey: document.getElementById('apiKey').value.trim(),
                apiUrl: document.getElementById('apiUrl').value.trim(),
                model: document.getElementById('modelSelect').value
            };

            // è§„èŒƒåŒ– URL
            if (newConfig.apiUrl) {
                if (!newConfig.apiUrl.startsWith('http://') && !newConfig.apiUrl.startsWith('https://')) {
                    newConfig.apiUrl = 'https://' + newConfig.apiUrl;
                }
                if (newConfig.apiUrl.endsWith('/')) {
                    newConfig.apiUrl = newConfig.apiUrl.slice(0, -1);
                }
                document.getElementById('apiUrl').value = newConfig.apiUrl;
            }

            // æ£€æŸ¥æ˜¯æ›´æ–°è¿˜æ˜¯æ–°å¢
            const index = document.getElementById('savedConfigs').value;
            if (index !== "") {
                state.configList[index] = newConfig;
            } else {
                state.configList.push(newConfig);
            }

            // ä¿å­˜åˆ—è¡¨
            localStorage.setItem('jj_config_list', JSON.stringify(state.configList));
            
            // åŒæ—¶åº”ç”¨ä¸ºå½“å‰é…ç½®
            state.config = newConfig;
            localStorage.setItem('jj_config', JSON.stringify(state.config));

            alert("é…ç½®å·²ä¿å­˜å¹¶åº”ç”¨ï¼");
            loadSettingsUI(); // åˆ·æ–°åˆ—è¡¨
            
            // é€‰ä¸­åˆšæ‰ä¿å­˜çš„
            const newIndex = state.configList.findIndex(c => c.name === name);
            if(newIndex !== -1) document.getElementById('savedConfigs').value = newIndex;
        }

        function deleteConfig() {
            const index = document.getElementById('savedConfigs').value;
            if (index === "") return alert("è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„é…ç½®");
            
            if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé…ç½®å—ï¼Ÿ")) return;
            
            state.configList.splice(index, 1);
            localStorage.setItem('jj_config_list', JSON.stringify(state.configList));
            
            alert("é…ç½®å·²åˆ é™¤");
            loadSettingsUI();
        }

        function applyConfigOnly() {
            const tempConfig = {
                apiKey: document.getElementById('apiKey').value.trim(),
                apiUrl: document.getElementById('apiUrl').value.trim(),
                model: document.getElementById('modelSelect').value
            };
            
            state.config = tempConfig;
            localStorage.setItem('jj_config', JSON.stringify(state.config));
            alert("å·²ä¸´æ—¶åº”ç”¨å½“å‰è®¾ç½®ï¼ˆæœªä¿å­˜åˆ°é…ç½®åˆ—è¡¨ï¼‰");
        }

        async function fetchModels() {
            const key = document.getElementById('apiKey').value.trim();
            let baseUrl = document.getElementById('apiUrl').value.trim() || 'https://generativelanguage.googleapis.com';
            
            if(!key) return alert("è¯·å…ˆè¾“å…¥API Key");
            
            if(baseUrl.endsWith('/')) baseUrl = baseUrl.slice(0, -1);
            
            let url = baseUrl;
            // æ™ºèƒ½æ„å»º list models URL
            if (!url.includes('/models')) {
                if (!url.includes('/v1beta') && !url.includes('/v1')) {
                    url += '/v1beta';
                }
                url += '/models';
            }

            const separator = url.includes('?') ? '&' : '?';
            const finalUrl = `${url}${separator}key=${key}`;

            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "æ‹‰å–ä¸­...";
            btn.disabled = true;

            try {
                const response = await fetch(finalUrl);
                if(!response.ok) throw new Error(response.statusText);
                
                const data = await response.json();
                if(data.models) {
                    const select = document.getElementById('modelSelect');
                    // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™å½“å‰é€‰ä¸­çš„å¦‚æœå­˜åœ¨ï¼‰
                    const currentVal = select.value;
                    
                    data.models.forEach(m => {
                        // è¿‡æ»¤æ‰ä¸æ”¯æŒç”Ÿæˆçš„æ¨¡å‹
                        if(!m.supportedGenerationMethods.includes("generateContent")) return;
                        
                        const modelName = m.name.replace('models/', '');
                        let exists = false;
                        for(let i=0; i<select.options.length; i++) {
                            if(select.options[i].value === modelName) exists = true;
                        }
                        if(!exists) {
                            const opt = document.createElement('option');
                            opt.value = modelName;
                            opt.text = `${modelName} (${m.displayName})`;
                            select.add(opt);
                        }
                    });
                    alert(`æˆåŠŸæ‹‰å– ${data.models.length} ä¸ªæ¨¡å‹`);
                }
            } catch(e) {
                console.error(e);
                alert("æ‹‰å–æ¨¡å‹å¤±è´¥ï¼Œè¯·æ£€æŸ¥Keyæˆ–ç½‘ç»œã€‚\n" + e.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function toggleKeyVis(checkbox) {
            document.getElementById('apiKey').type = checkbox.checked ? 'text' : 'password';
        }

        navTo('home');
    </script>
</body>
</html>
